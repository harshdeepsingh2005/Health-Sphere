{% extends "base_simple.html" %}
{% load static %}

{% block title %}AI Health Assistant - HealthSphere AI{% endblock %}

{% block extra_css %}
<style>
/* =============================================
   AI Assistant Styles
   ============================================= */

.assistant-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem 1rem;
}

.assistant-header {
    background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
    color: white;
    padding: 2rem;
    border-radius: 0.75rem;
    margin-bottom: 2rem;
    text-align: center;
}

.chat-container {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 2rem;
    height: 600px;
}

.sidebar {
    background: white;
    border-radius: 0.75rem;
    padding: 1.5rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    border: 1px solid #e2e8f0;
    overflow-y: auto;
}

.chat-main {
    background: white;
    border-radius: 0.75rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    border: 1px solid #e2e8f0;
    display: flex;
    flex-direction: column;
}

.chat-messages {
    flex: 1;
    padding: 1.5rem;
    overflow-y: auto;
    background: linear-gradient(to bottom, #f8fafc, white);
}

.message {
    margin-bottom: 1.5rem;
    animation: slideIn 0.3s ease-out;
}

.message-user {
    text-align: right;
}

.message-ai {
    text-align: left;
}

.message-bubble {
    display: inline-block;
    padding: 1rem 1.25rem;
    border-radius: 1.25rem;
    max-width: 80%;
    word-wrap: break-word;
}

.message-user .message-bubble {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    color: white;
    border-bottom-right-radius: 0.25rem;
}

.message-ai .message-bubble {
    background: #f1f5f9;
    color: #334155;
    border: 1px solid #e2e8f0;
    border-bottom-left-radius: 0.25rem;
}

.message-time {
    font-size: 0.75rem;
    color: #64748b;
    margin-top: 0.5rem;
}

.chat-input-area {
    padding: 1.5rem;
    border-top: 1px solid #e2e8f0;
    background: #f8fafc;
    border-radius: 0 0 0.75rem 0.75rem;
}

.input-group {
    display: flex;
    gap: 0.75rem;
}

.message-input {
    flex: 1;
    padding: 0.75rem 1rem;
    border: 2px solid #e2e8f0;
    border-radius: 2rem;
    outline: none;
    transition: border-color 0.2s ease;
    font-size: 1rem;
}

.message-input:focus {
    border-color: #8b5cf6;
}

.send-button {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, #8b5cf6, #6366f1);
    color: white;
    border: none;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: transform 0.2s ease;
}

.send-button:hover {
    transform: scale(1.05);
}

.send-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

.quick-questions {
    margin-bottom: 1.5rem;
}

.section-title {
    font-size: 1rem;
    font-weight: 600;
    color: #374151;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.quick-question-btn {
    display: block;
    width: 100%;
    text-align: left;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 0.5rem;
    color: #475569;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.quick-question-btn:hover {
    background: #f1f5f9;
    border-color: #8b5cf6;
    color: #6366f1;
}

.patient-context {
    background: #f0f9ff;
    border: 1px solid #bae6fd;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1.5rem;
}

.context-item {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
}

.context-label {
    font-weight: 500;
    color: #0369a1;
}

.context-value {
    color: #0c4a6e;
    font-weight: 600;
}

.ai-avatar {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #8b5cf6, #6366f1);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    float: left;
    margin-right: 0.75rem;
    margin-bottom: 0.5rem;
}

.user-avatar {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    float: right;
    margin-left: 0.75rem;
    margin-bottom: 0.5rem;
}

.typing-indicator {
    display: none;
    align-items: center;
    gap: 0.5rem;
    color: #64748b;
    font-style: italic;
    margin-bottom: 1rem;
}

.typing-dots {
    display: flex;
    gap: 0.25rem;
}

.typing-dot {
    width: 6px;
    height: 6px;
    background: #64748b;
    border-radius: 50%;
    animation: typing 1.4s infinite;
}

.typing-dot:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-dot:nth-child(3) {
    animation-delay: 0.4s;
}

.welcome-message {
    text-align: center;
    color: #64748b;
    padding: 2rem;
    font-style: italic;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes typing {
    0%, 60%, 100% {
        transform: translateY(0);
    }
    30% {
        transform: translateY(-10px);
    }
}

@media (max-width: 768px) {
    .chat-container {
        grid-template-columns: 1fr;
        height: auto;
    }
    
    .sidebar {
        order: 2;
        height: auto;
    }
    
    .chat-main {
        height: 500px;
    }
}

.suggestions-area {
    padding: 0.75rem 1.5rem 0;
    display: none;
}

.suggestion-chip {
    display: inline-block;
    padding: 0.375rem 0.75rem;
    background: #f1f5f9;
    border: 1px solid #e2e8f0;
    border-radius: 1rem;
    font-size: 0.75rem;
    color: #475569;
    margin-right: 0.5rem;
    margin-bottom: 0.5rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.suggestion-chip:hover {
    background: #e2e8f0;
    color: #334155;
}
</style>
{% endblock %}

{% block content %}
<div class="assistant-container">
    <!-- Header -->
    <div class="assistant-header">
        <h1 class="h2 mb-3">
            <i class="fas fa-robot me-3"></i>
            AI Health Assistant
        </h1>
        <p class="mb-0 opacity-90">
            Get instant answers to your health questions and personalized guidance
        </p>
    </div>

    <!-- Main Chat Interface -->
    <div class="chat-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Patient Context -->
            <div class="patient-context">
                <h6 class="section-title">
                    <i class="fas fa-user text-primary"></i>
                    Your Context
                </h6>
                
                {% if recent_vitals %}
                <div class="context-item">
                    <span class="context-label">Last Vitals:</span>
                    <span class="context-value">{{ recent_vitals.recorded_at|date:"M d" }}</span>
                </div>
                {% endif %}
                
                {% if active_treatment %}
                <div class="context-item">
                    <span class="context-label">Active Treatment:</span>
                    <span class="context-value">{{ active_treatment.title|truncatechars:20 }}</span>
                </div>
                {% endif %}
                
                <div class="context-item">
                    <span class="context-label">Health Score:</span>
                    <span class="context-value">75/100</span>
                </div>
            </div>

            <!-- Quick Questions -->
            <div class="quick-questions">
                <h6 class="section-title">
                    <i class="fas fa-lightning-bolt text-warning"></i>
                    Quick Questions
                </h6>
                
                {% for question in quick_questions %}
                <button class="quick-question-btn" data-question="{{ question }}">
                    {{ question }}
                </button>
                {% endfor %}
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="chat-main">
            <!-- Messages Area -->
            <div class="chat-messages" id="messages-area">
                <div class="welcome-message">
                    <div class="ai-avatar mb-3" style="float: none; margin: 0 auto;">
                        <i class="fas fa-robot"></i>
                    </div>
                    <p class="mb-2">ðŸ‘‹ Hello! I'm your AI Health Assistant.</p>
                    <p class="mb-0">I'm here to help you understand your health data, medications, and answer any questions you might have. How can I assist you today?</p>
                </div>
            </div>
            
            <!-- Typing Indicator -->
            <div class="typing-indicator" id="typing-indicator">
                <div class="ai-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <span>AI is thinking</span>
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
            
            <!-- Suggestions Area -->
            <div class="suggestions-area" id="suggestions-area">
                <div class="suggestion-chip">Tell me more</div>
                <div class="suggestion-chip">Schedule appointment</div>
                <div class="suggestion-chip">Explain terms</div>
            </div>

            <!-- Input Area -->
            <div class="chat-input-area">
                <form id="chat-form" method="post">
                    {% csrf_token %}
                    <div class="input-group">
                        <input type="text" 
                               name="question" 
                               id="message-input" 
                               class="message-input" 
                               placeholder="Ask me anything about your health..."
                               autocomplete="off"
                               required>
                        <button type="submit" class="send-button" id="send-button">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const messagesArea = document.getElementById('messages-area');
    const typingIndicator = document.getElementById('typing-indicator');
    const suggestionsArea = document.getElementById('suggestions-area');
    
    // Quick question buttons
    const quickQuestionBtns = document.querySelectorAll('.quick-question-btn');
    quickQuestionBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const question = this.getAttribute('data-question');
            messageInput.value = question;
            sendMessage();
        });
    });
    
    // Handle form submission
    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        sendMessage();
    });
    
    // Handle Enter key
    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    function sendMessage() {
        const message = messageInput.value.trim();
        if (!message) return;
        
        // Add user message to chat
        addMessage(message, 'user');
        
        // Clear input and disable send button
        messageInput.value = '';
        sendButton.disabled = true;
        
        // Show typing indicator
        typingIndicator.style.display = 'flex';
        scrollToBottom();
        
        // Simulate API call
        setTimeout(() => {
            // Hide typing indicator
            typingIndicator.style.display = 'none';
            
            // Add AI response
            const response = generateMockResponse(message);
            addMessage(response, 'ai');
            
            // Re-enable send button
            sendButton.disabled = false;
            messageInput.focus();
            
            // Show suggestions
            showSuggestions();
        }, 1500 + Math.random() * 1000);
    }
    
    function addMessage(content, sender) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message message-${sender}`;
        
        const now = new Date();
        const timeStr = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        if (sender === 'ai') {
            messageDiv.innerHTML = `
                <div class="ai-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-bubble">${content}</div>
                <div class="message-time">${timeStr}</div>
            `;
        } else {
            messageDiv.innerHTML = `
                <div class="user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="message-bubble">${content}</div>
                <div class="message-time">${timeStr}</div>
            `;
        }
        
        // Remove welcome message if it exists
        const welcomeMsg = messagesArea.querySelector('.welcome-message');
        if (welcomeMsg) {
            welcomeMsg.remove();
        }
        
        messagesArea.appendChild(messageDiv);
        scrollToBottom();
    }
    
    function generateMockResponse(question) {
        const responses = {
            'medication': 'Based on your current treatment plan, you should take your medication with food at the same time each day. This helps maintain consistent levels in your system and reduces potential side effects.',
            'lab': 'Your recent lab results show improvement in your key health markers. Your cholesterol levels have decreased by 15% since your last visit, which is excellent progress.',
            'health': 'Your current health score of 75 is good! To improve it further, focus on regular exercise (150 minutes per week), maintaining your medication schedule, and following up on your upcoming appointments.',
            'appointment': 'Your next appointment is scheduled for March 15th at 2:30 PM with Dr. Johnson. I can help you prepare questions or reschedule if needed.',
            'diet': 'For your condition, I recommend a heart-healthy diet rich in omega-3 fatty acids, whole grains, and fresh vegetables. Limit processed foods and excess sodium. Would you like specific meal suggestions?',
            'side effects': 'Common side effects of your current medication may include mild dizziness and stomach upset. These typically improve within the first few weeks. Contact your doctor if symptoms persist or worsen.'
        };
        
        const lowerQuestion = question.toLowerCase();
        
        for (const [key, response] of Object.entries(responses)) {
            if (lowerQuestion.includes(key)) {
                return response;
            }
        }
        
        return `I understand you're asking about "${question}". Based on your health profile, I recommend discussing this with your healthcare provider during your next appointment. In the meantime, I can help you with information about your current medications, upcoming appointments, or general health guidance.`;
    }
    
    function showSuggestions() {
        const suggestions = ['Tell me more about my treatment', 'Schedule an appointment', 'Explain medical terms'];
        const suggestionsHtml = suggestions.map(s => 
            `<div class="suggestion-chip" onclick="handleSuggestion('${s}')">${s}</div>`
        ).join('');
        
        suggestionsArea.innerHTML = suggestionsHtml;
        suggestionsArea.style.display = 'block';
        
        setTimeout(() => {
            suggestionsArea.style.display = 'none';
        }, 10000);
    }
    
    function handleSuggestion(suggestion) {
        messageInput.value = suggestion;
        sendMessage();
    }
    
    function scrollToBottom() {
        messagesArea.scrollTop = messagesArea.scrollHeight;
    }
    
    // Focus on input when page loads
    messageInput.focus();
    
    // Make handleSuggestion globally available
    window.handleSuggestion = handleSuggestion;
    
    console.log('AI Assistant initialized');
});
</script>
{% endblock %}
