{% extends "base_simple.html" %}
{% load static %}

{% block title %}{{ page_title|default:"My Health Dashboard" }} - HealthSphere AI{% endblock %}

{% block extra_css %}
<style>
/* =============================================
   Patient Dashboard Styles - Soft Glass Healthcare
   ============================================= */

.dashboard-main {
    padding: var(--spacing-6, 24px);
    background: var(--neutral-25, #fefefe);
    min-height: 100vh;
}

.dashboard-container {
    max-width: 1400px;
    margin: 0 auto;
}

.dashboard-header {
    margin-bottom: var(--spacing-8, 32px);
}

.welcome-card {
    background: linear-gradient(135deg, 
        rgba(240, 253, 244, 0.95) 0%, 
        rgba(255, 255, 255, 0.94) 100%);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(34, 197, 94, 0.08);
    box-shadow: 0 2px 16px rgba(0, 0, 0, 0.04);
    border-radius: var(--radius-2xl, 20px);
    padding: var(--spacing-8, 32px);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.welcome-content h1 {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--neutral-900, #111827);
    margin-bottom: var(--spacing-2, 8px);
}

.welcome-content p {
    font-size: 1.125rem;
    color: var(--neutral-600, #6b7280);
    margin-bottom: var(--spacing-4, 16px);
}

.wellness-streak {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-2, 8px);
    background: linear-gradient(135deg, #fbbf24, #f59e0b);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-weight: 700;
    font-size: 1.125rem;
}

.streak-icon {
    font-size: 1.5rem;
    filter: none;
    -webkit-text-fill-color: initial;
}

.health-score-circle {
    position: relative;
    width: 120px;
    height: 120px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.health-score-circle:hover {
    transform: scale(1.05);
}

.score-inner {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    z-index: 2;
}

.score-number {
    display: block;
    font-size: 1.875rem;
    font-weight: 800;
    color: var(--healthcare-primary, #3b82f6);
    line-height: 1;
}

.score-label {
    display: block;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--neutral-600, #6b7280);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-top: 2px;
}

.progress-ring {
    position: absolute;
    top: 0;
    left: 0;
    transform: rotate(-90deg);
}

.progress-ring__circle {
    stroke: var(--healthcare-primary, #3b82f6);
    fill: transparent;
    stroke-width: 8;
    stroke-linecap: round;
    transition: stroke-dasharray 1s ease-in-out;
}

.dashboard-grid {
    display: grid;
    gap: var(--spacing-6, 24px);
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
}

@media (max-width: 768px) {
    .dashboard-grid {
        grid-template-columns: 1fr;
    }
    
    .welcome-card {
        flex-direction: column;
        gap: var(--spacing-6, 24px);
        text-align: center;
    }
}

.dashboard-section {
    min-height: 300px;
}

.card-content {
    padding: var(--spacing-4, 16px);
}

.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: var(--spacing-3, 12px);
    margin-bottom: var(--spacing-4, 16px);
}

.trend-indicator {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-2, 8px);
    padding: var(--spacing-3, 12px);
    border-radius: var(--radius-lg, 12px);
    background: var(--neutral-50, #f9fafb);
}

.trend-improving .trend-text { color: var(--healthcare-success, #10b981); }
.trend-stable .trend-text { color: var(--healthcare-primary, #3b82f6); }
.trend-declining .trend-text { color: var(--healthcare-danger, #ef4444); }

.appointments-list {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-3, 12px);
}

.appointment-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-4, 16px);
    padding: var(--spacing-4, 16px);
    background: var(--neutral-50, #f9fafb);
    border-radius: var(--radius-lg, 12px);
    border: 1px solid var(--neutral-200, #e5e7eb);
    transition: all 0.3s ease;
}

.appointment-item:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

.appointment-time {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 60px;
}

.appointment-time .date {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--healthcare-primary, #3b82f6);
}

.appointment-time .time {
    font-size: 0.75rem;
    color: var(--neutral-600, #6b7280);
}

.appointment-details {
    flex: 1;
}

.appointment-details h4 {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--neutral-900, #111827);
    margin-bottom: 2px;
}

.appointment-details p {
    font-size: 0.75rem;
    color: var(--neutral-600, #6b7280);
    margin: 0;
}

.appointment-actions {
    display: flex;
    align-items: center;
    gap: var(--spacing-2, 8px);
}

.medications-list {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-3, 12px);
}

.medication-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--spacing-4, 16px);
    background: var(--neutral-50, #f9fafb);
    border-radius: var(--radius-lg, 12px);
    border: 1px solid var(--neutral-200, #e5e7eb);
    transition: all 0.3s ease;
}

.medication-item:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

.medication-info h4 {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--neutral-900, #111827);
    margin-bottom: 2px;
}

.medication-info p {
    font-size: 0.75rem;
    color: var(--neutral-600, #6b7280);
    margin: 0;
}

.medication-actions {
    display: flex;
    gap: var(--spacing-2, 8px);
}

.ai-insights {
    margin-bottom: var(--spacing-4, 16px);
}

.insight-item {
    display: flex;
    align-items: flex-start;
    gap: var(--spacing-3, 12px);
    padding: var(--spacing-4, 16px);
    background: var(--neutral-50, #f9fafb);
    border-radius: var(--radius-lg, 12px);
    border-left: 4px solid var(--healthcare-primary, #3b82f6);
    margin-bottom: var(--spacing-3, 12px);
}

.insight-item.high {
    border-left-color: var(--healthcare-danger, #ef4444);
    background: rgba(239, 68, 68, 0.05);
}

.insight-item.medium {
    border-left-color: var(--healthcare-warning, #f59e0b);
    background: rgba(245, 158, 11, 0.05);
}

.insight-item.low {
    border-left-color: var(--healthcare-success, #10b981);
    background: rgba(16, 185, 129, 0.05);
}

.insight-icon {
    font-size: 1.25rem;
    line-height: 1;
}

.insight-content h4 {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--neutral-900, #111827);
    margin-bottom: var(--spacing-1, 4px);
}

.insight-content p {
    font-size: 0.8125rem;
    color: var(--neutral-600, #6b7280);
    margin-bottom: var(--spacing-2, 8px);
}

.insight-action {
    font-size: 0.75rem;
    color: var(--healthcare-primary, #3b82f6);
    text-decoration: none;
    font-weight: 600;
}

.insight-action:hover {
    text-decoration: underline;
}

.ai-chat-prompt {
    display: flex;
    gap: var(--spacing-2, 8px);
}

.chat-input {
    flex: 1;
    padding: var(--spacing-3, 12px);
    border: 1px solid var(--neutral-200, #e5e7eb);
    border-radius: var(--radius-lg, 12px);
    font-size: 0.875rem;
    background: white;
    transition: border-color 0.3s ease;
}

.chat-input:focus {
    outline: none;
    border-color: var(--healthcare-primary, #3b82f6);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: var(--spacing-3, 12px);
}

.action-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--spacing-2, 8px);
    padding: var(--spacing-4, 16px);
    background: var(--neutral-50, #f9fafb);
    border-radius: var(--radius-lg, 12px);
    text-decoration: none;
    color: inherit;
    transition: all 0.3s ease;
}

.action-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    background: white;
}

.action-icon {
    font-size: 1.5rem;
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--healthcare-primary-bg, rgba(59, 130, 246, 0.1));
    color: var(--healthcare-primary, #3b82f6);
    border-radius: var(--radius-lg, 12px);
    transition: all 0.3s ease;
}

.action-item:hover .action-icon {
    transform: scale(1.1);
}

.action-text {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--neutral-700, #374151);
    text-align: center;
}

.activity-timeline {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-3, 12px);
}

.activity-item {
    display: flex;
    align-items: flex-start;
    gap: var(--spacing-3, 12px);
    padding: var(--spacing-3, 12px);
}

.activity-time {
    font-size: 0.75rem;
    color: var(--neutral-500, #6b7280);
    white-space: nowrap;
    min-width: 80px;
}

.activity-content {
    display: flex;
    align-items: center;
    gap: var(--spacing-2, 8px);
    flex: 1;
}

.activity-icon {
    font-size: 1rem;
}

.activity-text {
    font-size: 0.875rem;
    color: var(--neutral-700, #374151);
}

.empty-state {
    text-align: center;
    padding: var(--spacing-8, 32px);
    color: var(--neutral-500, #6b7280);
}

.empty-icon {
    font-size: 3rem;
    margin-bottom: var(--spacing-4, 16px);
    opacity: 0.6;
}

.empty-text {
    font-size: 0.875rem;
    margin-bottom: var(--spacing-4, 16px);
}

.ai-placeholder {
    text-align: center;
    padding: var(--spacing-6, 24px);
}

.ai-icon {
    font-size: 2.5rem;
    margin-bottom: var(--spacing-3, 12px);
}

.ai-message {
    font-size: 0.875rem;
    color: var(--neutral-600, #6b7280);
    margin-bottom: var(--spacing-4, 16px);
}

.btn-icon {
    width: 32px;
    height: 32px;
    border-radius: var(--radius-lg, 12px);
    border: 1px solid var(--neutral-200, #e5e7eb);
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--neutral-600, #6b7280);
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-icon:hover {
    background: var(--neutral-50, #f9fafb);
    border-color: var(--neutral-300, #d1d5db);
}

/* Animation for health score circle */
@keyframes fillScore {
    from { stroke-dasharray: 0 100; }
}

.progress-ring__circle {
    animation: fillScore 2s ease-out 0.5s both;
}

/* Hover animations for dashboard sections */
.dashboard-section {
    transition: transform 0.3s ease;
}

.dashboard-section:hover {
    transform: translateY(-2px);
}
</style>
{% endblock %}

{% block content %}
<main class="dashboard-main">
    <div class="dashboard-container">
        <!-- Dashboard Header with Welcome Card -->
        <div class="dashboard-header">
            <div class="welcome-card">
                <div class="welcome-content">
                    <h1 class="welcome-title">{{ greeting }}, {{ user.first_name }}!</h1>
                    <p class="welcome-subtitle">Here's your health overview for today</p>
                    <div class="wellness-streak">
                        <span class="streak-icon">üî•</span>
                        <span class="streak-text">{{ wellness_streak }} day streak</span>
                    </div>
                </div>
                <div class="welcome-visual">
                    <div class="health-score-circle" data-score="{{ health_score }}">
                        <div class="score-inner">
                            <span class="score-number">{{ health_score }}</span>
                            <span class="score-label">Health Score</span>
                        </div>
                        <svg class="progress-ring" width="120" height="120">
                            <circle class="progress-ring__circle" 
                                   stroke-dasharray="{{ health_score|floatformat:0 }} 100" 
                                   stroke-dashoffset="0" 
                                   r="52" cx="60" cy="60"/>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Health Overview Section -->
            <section class="dashboard-section health-overview">
                {% include 'components/card.html' with title="Health Overview" class="health-overview-card" %}
                <div class="card-content">
                    <div class="metrics-grid">
                        {% if weight_metrics %}
                            {% include 'components/metric_card.html' with 
                                label="Weight" 
                                value=weight_metrics.0.value
                                unit="kg"
                                trend="stable"
                                status="normal"
                            %}
                        {% endif %}
                        {% if blood_pressure_metrics %}
                            {% include 'components/metric_card.html' with 
                                label="Blood Pressure" 
                                value=blood_pressure_metrics.0.value
                                unit="mmHg"
                                trend="stable"
                                status="normal"
                            %}
                        {% endif %}
                        {% for metric in recent_records %}
                            {% include 'components/metric_card.html' with 
                                label=metric.record_type 
                                value="Recent"
                                unit=""
                                trend="stable"
                                status="normal"
                            %}
                        {% endfor %}
                    </div>
                    <div class="trend-indicator">
                        <span class="trend-text">{{ health_trend|title }} trend</span>
                        <span class="trend-icon trend-{{ health_trend }}">
                            {% if health_trend == 'improving' %}üìà{% elif health_trend == 'declining' %}üìâ{% else %}‚û°Ô∏è{% endif %}
                        </span>
                    </div>
                </div>
            </section>

            <!-- Upcoming Appointments -->
            <section class="dashboard-section appointments">
                {% include 'components/card.html' with title="Upcoming Appointments" class="appointments-card" %}
                <div class="card-content">
                    {% if upcoming_appointments %}
                    <div class="appointments-list">
                        {% for appointment in upcoming_appointments %}
                        <div class="appointment-item">
                            <div class="appointment-time">
                                <span class="date">{{ appointment.date|date:"M d" }}</span>
                                <span class="time">{{ appointment.time|time:"g:i A" }}</span>
                            </div>
                            <div class="appointment-details">
                                <h4 class="doctor-name">{{ appointment.doctor.user.get_full_name }}</h4>
                                <p class="appointment-type">{{ appointment.appointment_type }}</p>
                                {% if appointment.location %}
                                <p class="appointment-location">üìç {{ appointment.location }}</p>
                                {% endif %}
                            </div>
                            <div class="appointment-actions">
                                {% include 'components/badge.html' with text=appointment.status type=appointment.status|lower %}
                                <button class="btn-icon" title="Join Call">
                                    <i class="icon-video"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <div class="empty-icon">üìÖ</div>
                        <p class="empty-text">No upcoming appointments</p>
                        <a href="{% url 'patient_portal:book_appointment' %}" class="btn btn-secondary btn-sm">
                            Book Appointment
                        </a>
                    </div>
                    {% endif %}
                </div>
            </section>

            <!-- Current Medications -->
            <section class="dashboard-section medications">
                {% include 'components/card.html' with title="Current Medications" class="medications-card" %}
                <div class="card-content">
                    {% if recent_medications %}
                    <div class="medications-list">
                        {% for medication in recent_medications %}
                        <div class="medication-item">
                            <div class="medication-info">
                                <h4 class="medication-name">{{ medication.medication_name|default:"Treatment Plan" }}</h4>
                                <p class="medication-dosage">{{ medication.description }}</p>
                                <p class="medication-time">Active treatment</p>
                            </div>
                            <div class="medication-actions">
                                <button class="btn btn-success btn-sm" onclick="markTaken('{{ medication.id }}')">
                                    ‚úì Update
                                </button>
                                <button class="btn btn-outline btn-sm" onclick="viewDetails('{{ medication.id }}')">
                                    üëÅÔ∏è View
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <div class="empty-icon">üíä</div>
                        <p class="empty-text">No current medications</p>
                        <a href="{% url 'patient_portal:medications' %}" class="btn btn-secondary btn-sm">
                            Manage Medications
                        </a>
                    </div>
                    {% endif %}
                </div>
            </section>

            <!-- AI Health Assistant -->
            <section class="dashboard-section ai-assistant">
                {% include 'components/card.html' with title="AI Health Assistant" class="ai-assistant-card" %}
                <div class="card-content">
                    <div class="ai-insights">
                        {% if ai_insights %}
                        {% for insight in ai_insights %}
                        <div class="insight-item {{ insight.priority|lower }}">
                            <div class="insight-icon">
                                {% if insight.type == 'alert' %}üö®
                                {% elif insight.type == 'recommendation' %}üí°
                                {% elif insight.type == 'achievement' %}üèÜ
                                {% else %}‚ÑπÔ∏è{% endif %}
                            </div>
                            <div class="insight-content">
                                <h4 class="insight-title">{{ insight.title }}</h4>
                                <p class="insight-message">{{ insight.message }}</p>
                                {% if insight.action_url %}
                                <a href="{{ insight.action_url }}" class="insight-action">{{ insight.action_text }}</a>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="ai-placeholder">
                            <div class="ai-icon">ü§ñ</div>
                            <p class="ai-message">Your AI assistant is analyzing your health data...</p>
                            <button class="btn btn-primary btn-sm" onclick="refreshInsights()">
                                Get Insights
                            </button>
                        </div>
                        {% endif %}
                    </div>
                    <div class="ai-chat-prompt">
                        <input type="text" placeholder="Ask your health assistant..." class="chat-input">
                        <button class="btn btn-primary" onclick="sendChatMessage()">
                            <i class="icon-send"></i>
                        </button>
                    </div>
                </div>
            </section>

            <!-- Quick Actions -->
            <section class="dashboard-section quick-actions">
                {% include 'components/card.html' with title="Quick Actions" class="quick-actions-card" %}
                <div class="card-content">
                    <div class="actions-grid">
                        <a href="{% url 'patient_portal:book_appointment' %}" class="action-item">
                            <div class="action-icon">üìÖ</div>
                            <span class="action-text">Book Appointment</span>
                        </a>
                        <a href="{% url 'patient_portal:medications' %}" class="action-item">
                            <div class="action-icon">üíä</div>
                            <span class="action-text">Medications</span>
                        </a>
                        <a href="{% url 'patient_portal:health_records' %}" class="action-item">
                            <div class="action-icon">üìã</div>
                            <span class="action-text">Health Records</span>
                        </a>
                        <a href="{% url 'patient_portal:lab_results' %}" class="action-item">
                            <div class="action-icon">üß™</div>
                            <span class="action-text">Lab Results</span>
                        </a>
                        <a href="{% url 'patient_portal:chat_doctor' %}" class="action-item">
                            <div class="action-icon">üí¨</div>
                            <span class="action-text">Message Doctor</span>
                        </a>
                        <a href="{% url 'patient_portal:emergency_contacts' %}" class="action-item">
                            <div class="action-icon">üö®</div>
                            <span class="action-text">Emergency</span>
                        </a>
                    </div>
                </div>
            </section>

            <!-- Recent Activity -->
            <section class="dashboard-section recent-activity">
                {% include 'components/card.html' with title="Recent Activity" class="activity-card" %}
                <div class="card-content">
                    {% if recent_records %}
                    <div class="activity-timeline">
                        {% for record in recent_records %}
                        <div class="activity-item">
                            <div class="activity-time">{{ record.created_date|timesince }} ago</div>
                            <div class="activity-content">
                                <span class="activity-icon">üìã</span>
                                <span class="activity-text">{{ record.record_type|title }} record added</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <div class="empty-icon">üìà</div>
                        <p class="empty-text">No recent activity</p>
                    </div>
                    {% endif %}
                </div>
            </section>
        </div>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
// Dashboard interactivity
document.addEventListener('DOMContentLoaded', function() {
    // Animate health score circle on load
    const scoreCircle = document.querySelector('.progress-ring__circle');
    if (scoreCircle) {
        const score = document.querySelector('.health-score-circle').dataset.score || 75;
        const circumference = 2 * Math.PI * 52; // r=52
        const offset = circumference - (score / 100) * circumference;
        
        setTimeout(() => {
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = offset;
        }, 500);
    }

    // Add hover effects to dashboard sections
    document.querySelectorAll('.dashboard-section').forEach(section => {
        section.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
        });
        
        section.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });

    // Health score circle click for detailed view
    document.querySelector('.health-score-circle')?.addEventListener('click', function() {
        window.location.href = '{% url "patient_portal:health_details" %}';
    });
});

// Medication management functions
function markTaken(medicationId) {
    fetch(`/api/medications/${medicationId}/mark-taken/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
}

function snoozeReminder(medicationId) {
    fetch(`/api/medications/${medicationId}/snooze/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
}

// AI assistant functions
function refreshInsights() {
    fetch('/api/ai/refresh-insights/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
}

function sendChatMessage() {
    const input = document.querySelector('.chat-input');
    const message = input.value.trim();
    
    if (message) {
        fetch('/api/ai/chat/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message: message })
        })
        .then(response => response.json())
        .then(data => {
            input.value = '';
            // Handle chat response
            window.location.href = '/patient/ai-assistant/';
        });
    }
}
</script>
{% endblock %}
