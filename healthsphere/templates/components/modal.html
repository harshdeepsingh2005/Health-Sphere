{% comment %}
Modal Dialog Component - HealthSphere AI
========================================

Usage Examples:
{% include 'components/modal.html' with id="confirm-delete" title="Confirm Deletion" content="Are you sure you want to delete this patient record?" %}
{% include 'components/modal.html' with id="edit-patient" title="Edit Patient Information" size="large" %}
{% include 'components/modal.html' with id="appointment-details" title="Appointment Details" closeable=True dismissible=True %}

Parameters:
- id: Unique modal identifier (required)
- title: Modal header title (required)
- subtitle: Optional subtitle text
- content: Static content for modal body (optional)
- size: "sm", "md", "lg", "xl", "full" (default: md)
- variant: "default", "danger", "success", "info" (default: default)
- closeable: Boolean to show close button (default: True)
- dismissible: Boolean to close on overlay click (default: True)
- backdrop: "static" to prevent dismissal (optional)
- centered: Boolean to center modal vertically (default: True)
- scrollable: Boolean to make body scrollable (default: False)
- animation: "fade", "slide", "zoom" (default: fade)

Action Buttons (optional):
- primary_action: {text: "Save", action: "submit", class: "healthcare-btn-primary"}
- secondary_action: {text: "Cancel", action: "dismiss", class: "healthcare-btn-secondary"}

{% endcomment %}

<!-- Modal Overlay -->
<div class="healthcare-modal-overlay healthcare-modal-overlay-{{ animation|default:'fade' }}" 
     id="{{ id }}-overlay" 
     data-modal-id="{{ id }}"
     {% if not dismissible %}data-backdrop="static"{% endif %}
     style="display: none;">
    
    <!-- Modal Container -->
    <div class="healthcare-modal-container healthcare-modal-{{ size|default:'md' }}{% if centered %} healthcare-modal-centered{% endif %}{% if scrollable %} healthcare-modal-scrollable{% endif %}">
        
        <!-- Modal Dialog -->
        <div class="healthcare-modal healthcare-modal-{{ variant|default:'default' }}" 
             id="{{ id }}" 
             role="dialog" 
             aria-modal="true" 
             aria-labelledby="{{ id }}-title"
             {% if subtitle %}aria-describedby="{{ id }}-subtitle"{% endif %}>
            
            <!-- Modal Header -->
            <div class="healthcare-modal-header">
                <div class="healthcare-modal-title-section">
                    <h3 class="healthcare-modal-title" id="{{ id }}-title">{{ title }}</h3>
                    {% if subtitle %}
                    <p class="healthcare-modal-subtitle" id="{{ id }}-subtitle">{{ subtitle }}</p>
                    {% endif %}
                </div>
                
                {% if closeable|default:True %}
                <button class="healthcare-modal-close" 
                        type="button" 
                        aria-label="Close modal"
                        data-dismiss-modal="{{ id }}">
                    <i class="fas fa-times"></i>
                </button>
                {% endif %}
            </div>
            
            <!-- Modal Body -->
            <div class="healthcare-modal-body">
                {% if content %}
                <div class="healthcare-modal-content">
                    {{ content|safe }}
                </div>
                {% else %}
                <div class="healthcare-modal-content">
                    {% block modal_content %}
                    <!-- Dynamic content will be inserted here -->
                    {% endblock %}
                </div>
                {% endif %}
            </div>
            
            <!-- Modal Footer -->
            {% if primary_action or secondary_action %}
            <div class="healthcare-modal-footer">
                {% if secondary_action %}
                <button class="healthcare-btn {{ secondary_action.class|default:'healthcare-btn-secondary' }}" 
                        type="button"
                        {% if secondary_action.action == 'dismiss' %}data-dismiss-modal="{{ id }}"{% endif %}
                        {% if secondary_action.action and secondary_action.action != 'dismiss' %}data-action="{{ secondary_action.action }}"{% endif %}>
                    {% if secondary_action.icon %}
                    <i class="{{ secondary_action.icon }}"></i>
                    {% endif %}
                    <span>{{ secondary_action.text|default:"Cancel" }}</span>
                </button>
                {% endif %}
                
                {% if primary_action %}
                <button class="healthcare-btn {{ primary_action.class|default:'healthcare-btn-primary' }}" 
                        type="button"
                        {% if primary_action.action %}data-action="{{ primary_action.action }}"{% endif %}
                        {% if primary_action.loading %}data-loading-text="{{ primary_action.loading }}"{% endif %}>
                    {% if primary_action.icon %}
                    <i class="{{ primary_action.icon }}"></i>
                    {% endif %}
                    <span>{{ primary_action.text|default:"Confirm" }}</span>
                </button>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
/* =============================================
   Healthcare Modal Component Styles
   ============================================= */

/* Modal Overlay */
.healthcare-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    z-index: 1050;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--spacing-4, 16px);
    opacity: 0;
    visibility: hidden;
    transition: all var(--transition-base, 0.3s ease);
}

.healthcare-modal-overlay.show {
    opacity: 1;
    visibility: visible;
}

/* Modal Container */
.healthcare-modal-container {
    width: 100%;
    max-width: 500px;
    max-height: calc(100vh - var(--spacing-8, 32px));
    position: relative;
    transform: scale(0.9) translateY(20px);
    transition: all var(--transition-base, 0.3s ease);
}

.healthcare-modal-overlay.show .healthcare-modal-container {
    transform: scale(1) translateY(0);
}

/* Modal Centered */
.healthcare-modal-centered {
    margin: auto;
}

/* Modal Scrollable */
.healthcare-modal-scrollable .healthcare-modal-body {
    max-height: 60vh;
    overflow-y: auto;
}

/* Modal Dialog */
.healthcare-modal {
    background: var(--glass-bg, rgba(255, 255, 255, 0.95));
    backdrop-filter: var(--glass-blur, blur(20px));
    border: 1px solid var(--glass-border, rgba(255, 255, 255, 0.2));
    border-radius: var(--radius-2xl, 20px);
    box-shadow: var(--glass-shadow-2xl, 0 20px 64px rgba(0, 0, 0, 0.2));
    overflow: hidden;
    position: relative;
    display: flex;
    flex-direction: column;
    width: 100%;
}

/* Modal Variants */
.healthcare-modal-danger {
    border-left: 4px solid var(--healthcare-danger, #ef4444);
}

.healthcare-modal-success {
    border-left: 4px solid var(--healthcare-success, #10b981);
}

.healthcare-modal-info {
    border-left: 4px solid var(--healthcare-info, #3b82f6);
}

.healthcare-modal-warning {
    border-left: 4px solid var(--healthcare-warning, #f59e0b);
}

/* Modal Sizes */
.healthcare-modal-sm {
    max-width: 400px;
}

.healthcare-modal-md {
    max-width: 500px;
}

.healthcare-modal-lg {
    max-width: 700px;
}

.healthcare-modal-xl {
    max-width: 900px;
}

.healthcare-modal-full {
    max-width: calc(100vw - var(--spacing-8, 32px));
    max-height: calc(100vh - var(--spacing-8, 32px));
}

/* Modal Header */
.healthcare-modal-header {
    padding: var(--spacing-6, 24px);
    border-bottom: 1px solid var(--glass-border, rgba(255, 255, 255, 0.2));
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: var(--spacing-4, 16px);
    background: var(--neutral-50, #f9fafb);
    background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.8) 0%, 
        rgba(249, 250, 251, 0.6) 100%);
}

.healthcare-modal-title-section {
    flex: 1;
    min-width: 0;
}

.healthcare-modal-title {
    font-size: var(--font-size-xl, 20px);
    font-weight: var(--font-weight-semibold, 600);
    color: var(--text-primary, #1f2937);
    margin: 0;
    line-height: 1.3;
}

.healthcare-modal-subtitle {
    font-size: var(--font-size-sm, 14px);
    color: var(--text-secondary, #6b7280);
    margin: var(--spacing-1, 4px) 0 0 0;
    line-height: 1.4;
}

.healthcare-modal-close {
    width: 32px;
    height: 32px;
    border: none;
    border-radius: var(--radius-lg, 12px);
    background: transparent;
    color: var(--text-tertiary, #9ca3af);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-fast, 0.2s ease);
    flex-shrink: 0;
    font-size: var(--font-size-base, 16px);
}

.healthcare-modal-close:hover {
    background: var(--healthcare-danger-bg, rgba(239, 68, 68, 0.1));
    color: var(--healthcare-danger, #ef4444);
    transform: scale(1.1);
}

.healthcare-modal-close:active {
    transform: scale(0.95);
}

/* Modal Body */
.healthcare-modal-body {
    padding: var(--spacing-6, 24px);
    flex: 1;
    min-height: 0;
}

.healthcare-modal-scrollable .healthcare-modal-body {
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: var(--neutral-300, #d1d5db) transparent;
}

.healthcare-modal-scrollable .healthcare-modal-body::-webkit-scrollbar {
    width: 6px;
}

.healthcare-modal-scrollable .healthcare-modal-body::-webkit-scrollbar-track {
    background: transparent;
}

.healthcare-modal-scrollable .healthcare-modal-body::-webkit-scrollbar-thumb {
    background: var(--neutral-300, #d1d5db);
    border-radius: var(--radius-full, 9999px);
}

.healthcare-modal-scrollable .healthcare-modal-body::-webkit-scrollbar-thumb:hover {
    background: var(--neutral-400, #9ca3af);
}

/* Modal Content */
.healthcare-modal-content {
    color: var(--text-primary, #1f2937);
    line-height: 1.6;
}

.healthcare-modal-content p:first-child {
    margin-top: 0;
}

.healthcare-modal-content p:last-child {
    margin-bottom: 0;
}

/* Modal Footer */
.healthcare-modal-footer {
    padding: var(--spacing-6, 24px);
    border-top: 1px solid var(--glass-border, rgba(255, 255, 255, 0.2));
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: var(--spacing-3, 12px);
    background: var(--neutral-50, #f9fafb);
    background: linear-gradient(135deg, 
        rgba(249, 250, 251, 0.6) 0%, 
        rgba(255, 255, 255, 0.8) 100%);
}

.healthcare-modal-footer .healthcare-btn {
    min-width: 100px;
}

/* =============================================
   Modal Animations
   ============================================= */

/* Fade Animation */
.healthcare-modal-overlay-fade .healthcare-modal-container {
    transform: scale(0.95);
    opacity: 0;
}

.healthcare-modal-overlay-fade.show .healthcare-modal-container {
    transform: scale(1);
    opacity: 1;
}

/* Slide Animation */
.healthcare-modal-overlay-slide .healthcare-modal-container {
    transform: translateY(50px);
    opacity: 0;
}

.healthcare-modal-overlay-slide.show .healthcare-modal-container {
    transform: translateY(0);
    opacity: 1;
}

/* Zoom Animation */
.healthcare-modal-overlay-zoom .healthcare-modal-container {
    transform: scale(0.7);
    opacity: 0;
}

.healthcare-modal-overlay-zoom.show .healthcare-modal-container {
    transform: scale(1);
    opacity: 1;
}

/* =============================================
   Loading State
   ============================================= */

.healthcare-modal-loading .healthcare-modal-body {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 120px;
    color: var(--text-secondary, #6b7280);
}

.healthcare-modal-loading .healthcare-modal-body::before {
    content: '';
    width: 32px;
    height: 32px;
    border: 3px solid var(--healthcare-primary-light, #60a5fa);
    border-top-color: var(--healthcare-primary, #3b82f6);
    border-radius: 50%;
    animation: healthcare-modal-spin 1s linear infinite;
    margin-right: var(--spacing-3, 12px);
}

@keyframes healthcare-modal-spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* =============================================
   Responsive Design
   ============================================= */

@media (max-width: 768px) {
    .healthcare-modal-overlay {
        padding: var(--spacing-2, 8px);
    }
    
    .healthcare-modal-container {
        max-height: calc(100vh - var(--spacing-4, 16px));
    }
    
    .healthcare-modal-sm,
    .healthcare-modal-md,
    .healthcare-modal-lg,
    .healthcare-modal-xl {
        max-width: 100%;
    }
    
    .healthcare-modal-header,
    .healthcare-modal-body,
    .healthcare-modal-footer {
        padding: var(--spacing-4, 16px);
    }
    
    .healthcare-modal-footer {
        flex-direction: column-reverse;
        align-items: stretch;
    }
    
    .healthcare-modal-footer .healthcare-btn {
        width: 100%;
        justify-content: center;
    }
    
    .healthcare-modal-title {
        font-size: var(--font-size-lg, 18px);
    }
}

@media (max-width: 480px) {
    .healthcare-modal-overlay {
        padding: 0;
        align-items: flex-end;
    }
    
    .healthcare-modal-container {
        max-height: 90vh;
    }
    
    .healthcare-modal {
        border-radius: var(--radius-2xl, 20px) var(--radius-2xl, 20px) 0 0;
        margin-top: auto;
    }
    
    .healthcare-modal-overlay-slide .healthcare-modal-container {
        transform: translateY(100%);
    }
    
    .healthcare-modal-overlay-slide.show .healthcare-modal-container {
        transform: translateY(0);
    }
}

/* =============================================
   Dark Mode Support
   ============================================= */

@media (prefers-color-scheme: dark) {
    .healthcare-modal {
        background: rgba(17, 24, 39, 0.95);
        border-color: rgba(75, 85, 99, 0.3);
    }
    
    .healthcare-modal-header,
    .healthcare-modal-footer {
        background: linear-gradient(135deg, 
            rgba(31, 41, 55, 0.6) 0%, 
            rgba(17, 24, 39, 0.8) 100%);
    }
    
    .healthcare-modal-title {
        color: var(--neutral-white, #ffffff);
    }
    
    .healthcare-modal-subtitle {
        color: var(--neutral-300, #d1d5db);
    }
    
    .healthcare-modal-content {
        color: var(--neutral-200, #e5e7eb);
    }
}

/* =============================================
   Accessibility Enhancements
   ============================================= */

/* Focus trap styling */
.healthcare-modal:focus {
    outline: none;
}

.healthcare-modal-close:focus-visible,
.healthcare-modal .healthcare-btn:focus-visible {
    outline: 2px solid var(--healthcare-primary, #3b82f6);
    outline-offset: 2px;
}

/* Reduced motion */
@media (prefers-reduced-motion: reduce) {
    .healthcare-modal-overlay,
    .healthcare-modal-container,
    .healthcare-modal-close {
        transition: none;
    }
    
    .healthcare-modal-overlay.show .healthcare-modal-container {
        transform: none;
    }
    
    .healthcare-modal-loading .healthcare-modal-body::before {
        animation: none;
    }
}

/* High contrast mode */
@media (prefers-contrast: high) {
    .healthcare-modal {
        border-width: 2px;
    }
    
    .healthcare-modal-header,
    .healthcare-modal-footer {
        border-width: 2px;
    }
}
</style>

<script>
// Healthcare Modal Component JavaScript
document.addEventListener('DOMContentLoaded', function() {
    initializeHealthcareModals();
});

function initializeHealthcareModals() {
    // Initialize close buttons
    document.querySelectorAll('[data-dismiss-modal]').forEach(closeBtn => {
        closeBtn.addEventListener('click', function() {
            const modalId = this.getAttribute('data-dismiss-modal');
            hideModal(modalId);
        });
    });
    
    // Initialize overlay dismissal
    document.querySelectorAll('.healthcare-modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', function(e) {
            if (e.target === this && !this.dataset.backdrop) {
                const modalId = this.getAttribute('data-modal-id');
                hideModal(modalId);
            }
        });
    });
    
    // Initialize keyboard navigation
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const visibleModal = document.querySelector('.healthcare-modal-overlay.show');
            if (visibleModal && !visibleModal.dataset.backdrop) {
                const modalId = visibleModal.getAttribute('data-modal-id');
                hideModal(modalId);
            }
        }
    });
    
    // Initialize action buttons
    document.querySelectorAll('.healthcare-modal [data-action]').forEach(actionBtn => {
        actionBtn.addEventListener('click', function() {
            const action = this.getAttribute('data-action');
            const modal = this.closest('.healthcare-modal');
            const modalId = modal.id;
            
            // Dispatch custom event
            const event = new CustomEvent('modalAction', {
                detail: {
                    modalId: modalId,
                    action: action,
                    element: this
                }
            });
            modal.dispatchEvent(event);
        });
    });
}

function showModal(modalId, options = {}) {
    const overlay = document.getElementById(`${modalId}-overlay`);
    const modal = document.getElementById(modalId);
    
    if (!overlay || !modal) {
        console.warn(`Modal with ID "${modalId}" not found`);
        return;
    }
    
    // Set loading state if specified
    if (options.loading) {
        modal.classList.add('healthcare-modal-loading');
    }
    
    // Update content if provided
    if (options.content) {
        const contentElement = modal.querySelector('.healthcare-modal-content');
        if (contentElement) {
            contentElement.innerHTML = options.content;
        }
    }
    
    // Show modal
    overlay.style.display = 'flex';
    
    // Force reflow and add show class
    requestAnimationFrame(() => {
        overlay.classList.add('show');
        
        // Focus management
        modal.focus();
        trapFocus(modal);
    });
    
    // Prevent body scroll
    document.body.style.overflow = 'hidden';
    
    // Dispatch custom event
    const event = new CustomEvent('modalShow', {
        detail: { modalId: modalId }
    });
    modal.dispatchEvent(event);
}

function hideModal(modalId) {
    const overlay = document.getElementById(`${modalId}-overlay`);
    const modal = document.getElementById(modalId);
    
    if (!overlay || !modal) return;
    
    // Remove show class
    overlay.classList.remove('show');
    
    // Hide modal after animation
    setTimeout(() => {
        overlay.style.display = 'none';
        modal.classList.remove('healthcare-modal-loading');
        
        // Restore body scroll
        document.body.style.overflow = '';
        
        // Restore focus
        restoreFocus();
    }, 300);
    
    // Dispatch custom event
    const event = new CustomEvent('modalHide', {
        detail: { modalId: modalId }
    });
    modal.dispatchEvent(event);
}

function updateModalContent(modalId, content) {
    const modal = document.getElementById(modalId);
    if (modal) {
        const contentElement = modal.querySelector('.healthcare-modal-content');
        if (contentElement) {
            contentElement.innerHTML = content;
        }
    }
}

function setModalLoading(modalId, loading = true) {
    const modal = document.getElementById(modalId);
    if (modal) {
        if (loading) {
            modal.classList.add('healthcare-modal-loading');
        } else {
            modal.classList.remove('healthcare-modal-loading');
        }
    }
}

// Focus management
let lastFocusedElement = null;

function trapFocus(modal) {
    lastFocusedElement = document.activeElement;
    
    const focusableElements = modal.querySelectorAll(
        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
    );
    
    const firstFocusable = focusableElements[0];
    const lastFocusable = focusableElements[focusableElements.length - 1];
    
    modal.addEventListener('keydown', function(e) {
        if (e.key === 'Tab') {
            if (e.shiftKey) {
                if (document.activeElement === firstFocusable) {
                    e.preventDefault();
                    lastFocusable.focus();
                }
            } else {
                if (document.activeElement === lastFocusable) {
                    e.preventDefault();
                    firstFocusable.focus();
                }
            }
        }
    });
    
    if (firstFocusable) {
        firstFocusable.focus();
    }
}

function restoreFocus() {
    if (lastFocusedElement) {
        lastFocusedElement.focus();
        lastFocusedElement = null;
    }
}

// Export utility functions
window.HealthcareModal = {
    show: showModal,
    hide: hideModal,
    updateContent: updateModalContent,
    setLoading: setModalLoading
};

// Auto-initialize modals with data attributes
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('[data-modal-target]').forEach(trigger => {
        trigger.addEventListener('click', function() {
            const modalId = this.getAttribute('data-modal-target');
            showModal(modalId);
        });
    });
});
</script>

<!-- Usage Examples (hidden) -->
<div style="display: none;">
    <!-- Trigger Buttons -->
    <button class="healthcare-btn healthcare-btn-primary" data-modal-target="example-modal">
        Open Modal
    </button>
    
    <button class="healthcare-btn healthcare-btn-danger" onclick="HealthcareModal.show('confirm-delete')">
        Delete Item
    </button>
    
    <!-- Example Modals -->
    {% include 'components/modal.html' with id="example-modal" title="Example Modal" content="<p>This is a sample modal with some content.</p>" %}
    
    {% include 'components/modal.html' with id="confirm-delete" title="Confirm Deletion" variant="danger" content="<p>Are you sure you want to delete this item? This action cannot be undone.</p>" primary_action="{text: 'Delete', action: 'confirm-delete', class: 'healthcare-btn-danger'}" secondary_action="{text: 'Cancel', action: 'dismiss'}" %}
</div>