{% extends "base.html" %}
{% load static %}
{% block title %}Interoperability Dashboard | HealthSphere AI{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/bento-grid.css' %}">
<style>
.io-wrap { padding: 0; }
.io-nav-bar {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    flex-wrap: wrap;
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 14px;
    padding: 0.75rem 1rem;
    margin-bottom: 1.75rem;
    box-shadow: 0 1px 4px rgba(0,0,0,0.04);
}
.io-nav-pill {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 7px 14px;
    border-radius: 10px;
    text-decoration: none;
    font-weight: 600;
    font-size: 0.8125rem;
    color: #64748b;
    transition: all .2s;
}
.io-nav-pill:hover { background: #f1f5f9; color: #1e293b; }
.io-nav-pill.active { background: linear-gradient(135deg, #3b82f6, #8b5cf6); color: white; }
.io-nav-pill i { font-size: 12px; }

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.25rem;
    margin-bottom: 1.75rem;
}
.stat-card {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: 0 1px 4px rgba(0,0,0,0.04);
    display: flex;
    align-items: center;
    gap: 1rem;
    text-decoration: none;
    transition: all 0.2s ease;
}
.stat-card:hover { border-color: #93c5fd; box-shadow: 0 4px 16px rgba(59,130,246,0.1); transform: translateY(-2px); }
.stat-icon {
    width: 52px;
    height: 52px;
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    flex-shrink: 0;
}
.stat-icon.blue { background: linear-gradient(135deg, #3b82f6, #60a5fa); color: white; }
.stat-icon.green { background: linear-gradient(135deg, #10b981, #34d399); color: white; }
.stat-icon.purple { background: linear-gradient(135deg, #8b5cf6, #a78bfa); color: white; }
.stat-icon.cyan { background: linear-gradient(135deg, #06b6d4, #22d3ee); color: white; }
.stat-icon.orange { background: linear-gradient(135deg, #f59e0b, #fcd34d); color: white; }
.stat-value { font-size: 2rem; font-weight: 800; color: #1e293b; line-height: 1; margin-bottom: 4px; }
.stat-label { font-size: 0.8125rem; color: #64748b; font-weight: 500; }
.stat-sub { font-size: 0.75rem; color: #94a3b8; margin-top: 2px; }

.content-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.25rem;
}
@media (max-width: 900px) { .content-grid { grid-template-columns: 1fr; } }

.panel { background: white; border: 1px solid #e2e8f0; border-radius: 16px; padding: 1.5rem; box-shadow: 0 1px 4px rgba(0,0,0,0.04); }
.panel-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.25rem; }
.panel-title { font-size: 1rem; font-weight: 700; color: #1e293b; display: flex; align-items: center; gap: 8px; }
.panel-action { font-size: 0.8125rem; color: #3b82f6; text-decoration: none; font-weight: 600; }
.panel-action:hover { text-decoration: underline; }

.tx-row { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid #f1f5f9; }
.tx-row:last-child { border-bottom: none; }
.tx-type { font-size: 0.8125rem; font-weight: 600; color: #334155; }
.tx-system { font-size: 0.75rem; color: #64748b; }
.badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px; border-radius: 999px; font-size: 0.75rem; font-weight: 600; }
.badge-completed { background: rgba(16,185,129,0.1); color: #10b981; }
.badge-failed { background: rgba(239,68,68,0.1); color: #ef4444; }
.badge-in_progress { background: rgba(59,130,246,0.1); color: #3b82f6; }
.badge-initiated { background: rgba(6,182,212,0.1); color: #06b6d4; }
.badge-timeout { background: rgba(245,158,11,0.1); color: #f59e0b; }
.badge-cancelled { background: rgba(100,116,139,0.1); color: #64748b; }

.system-row { display: flex; align-items: center; justify-content: space-between; padding: 0.875rem 1rem; border-radius: 12px; margin-bottom: 0.5rem; background: #f8fafc; transition: background 0.15s; }
.system-row:hover { background: #f1f5f9; }
.system-row:last-child { margin-bottom: 0; }
.sys-info { display: flex; align-items: center; gap: 0.75rem; }
.sys-icon { width: 36px; height: 36px; border-radius: 10px; background: rgba(59,130,246,0.1); color: #3b82f6; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; }
.sys-name { font-weight: 600; color: #1e293b; font-size: 0.875rem; }
.sys-type { font-size: 0.75rem; color: #64748b; }
.status-dot-badge { display: inline-flex; align-items: center; gap: 5px; padding: 4px 10px; border-radius: 999px; font-size: 0.75rem; font-weight: 600; }
.status-dot-badge::before { content: ''; width: 6px; height: 6px; border-radius: 50%; }
.status-dot-badge.connected { background: rgba(16,185,129,0.1); color: #10b981; }
.status-dot-badge.connected::before { background: #10b981; }
.status-dot-badge.disconnected { background: rgba(239,68,68,0.1); color: #ef4444; }
.status-dot-badge.disconnected::before { background: #ef4444; }
.status-dot-badge.error { background: rgba(245,158,11,0.1); color: #f59e0b; }
.status-dot-badge.error::before { background: #f59e0b; }
.status-dot-badge.unknown { background: rgba(100,116,139,0.1); color: #64748b; }
.status-dot-badge.unknown::before { background: #94a3b8; }

.perf-bar { background: #f1f5f9; border-radius: 8px; padding: 1rem; display: flex; align-items: center; gap: 1rem; }
.perf-val { font-size: 1.5rem; font-weight: 800; color: #1e293b; }
.perf-label { font-size: 0.8125rem; color: #64748b; }

.empty-msg { text-align: center; padding: 2rem; color: #94a3b8; font-size: 0.875rem; }
.empty-msg i { display: block; font-size: 2rem; margin-bottom: 0.5rem; }
</style>
{% endblock %}

{% block breadcrumb %}
<nav class="breadcrumb">
    <ol class="breadcrumb-list">
        <li class="breadcrumb-item"><span class="breadcrumb-current"><i class="fas fa-exchange-alt"></i> Interoperability</span></li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="io-wrap">

    <!-- Navigation Pills -->
    <div class="io-nav-bar">
        <a href="{% url 'interoperability:dashboard' %}" class="io-nav-pill active"><i class="fas fa-th-large"></i> Overview</a>
        <a href="{% url 'interoperability:external_systems_list' %}" class="io-nav-pill"><i class="fas fa-plug"></i> Systems</a>
        <a href="{% url 'interoperability:fhir_resources_list' %}" class="io-nav-pill"><i class="fas fa-fire"></i> FHIR</a>
        <a href="{% url 'interoperability:hl7_messages_list' %}" class="io-nav-pill"><i class="fas fa-envelope-open-text"></i> HL7</a>
        <a href="{% url 'interoperability:data_mappings_list' %}" class="io-nav-pill"><i class="fas fa-map"></i> Mappings</a>
        <a href="{% url 'interoperability:integration_transactions_list' %}" class="io-nav-pill"><i class="fas fa-receipt"></i> Transactions</a>
        <a href="{% url 'interoperability:consent_management_list' %}" class="io-nav-pill"><i class="fas fa-shield-alt"></i> Consents</a>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid">
        <a href="{% url 'interoperability:external_systems_list' %}" class="stat-card">
            <div class="stat-icon blue"><i class="fas fa-server"></i></div>
            <div>
                <div class="stat-value">{{ total_systems }}</div>
                <div class="stat-label">External Systems</div>
                <div class="stat-sub">{{ connected_systems }} connected · {{ connection_rate|floatformat:0 }}% uptime</div>
            </div>
        </a>
        <a href="{% url 'interoperability:fhir_resources_list' %}" class="stat-card">
            <div class="stat-icon green"><i class="fas fa-fire"></i></div>
            <div>
                <div class="stat-value">{{ fhir_stats.total_resources }}</div>
                <div class="stat-label">FHIR Resources</div>
                <div class="stat-sub">{{ fhir_stats.valid_resources }} valid · {{ fhir_stats.patients }} patients</div>
            </div>
        </a>
        <a href="{% url 'interoperability:hl7_messages_list' %}" class="stat-card">
            <div class="stat-icon purple"><i class="fas fa-envelope-open-text"></i></div>
            <div>
                <div class="stat-value">{{ hl7_stats.total_messages }}</div>
                <div class="stat-label">HL7 Messages</div>
                <div class="stat-sub">{{ hl7_stats.pending_messages }} pending · {{ hl7_stats.error_messages }} errors</div>
            </div>
        </a>
        <a href="{% url 'interoperability:integration_transactions_list' %}" class="stat-card">
            <div class="stat-icon cyan"><i class="fas fa-receipt"></i></div>
            <div>
                <div class="stat-value">{{ recent_transactions|length }}</div>
                <div class="stat-label">Recent Transactions</div>
                <div class="stat-sub">Avg {{ avg_response_time }}ms response time</div>
            </div>
        </a>
    </div>

    <!-- Content Grid -->
    <div class="content-grid">
        <!-- Recent Transactions -->
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title"><i class="fas fa-receipt" style="color:#06b6d4;"></i> Recent Transactions</div>
                <a href="{% url 'interoperability:integration_transactions_list' %}" class="panel-action">View all <i class="fas fa-arrow-right"></i></a>
            </div>
            {% if recent_transactions %}
            {% for tx in recent_transactions %}
            <div class="tx-row">
                <div>
                    <div class="tx-type">{{ tx.get_transaction_type_display }}</div>
                    <div class="tx-system">{{ tx.external_system.name }} · {{ tx.started_at|date:"M d, H:i" }}</div>
                </div>
                <span class="badge badge-{{ tx.status }}">{{ tx.get_status_display }}</span>
            </div>
            {% endfor %}
            {% else %}
            <div class="empty-msg"><i class="fas fa-receipt"></i>No recent transactions</div>
            {% endif %}
        </div>

        <!-- System Status -->
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title"><i class="fas fa-server" style="color:#3b82f6;"></i> System Status</div>
                <a href="{% url 'interoperability:external_systems_list' %}" class="panel-action">Manage <i class="fas fa-arrow-right"></i></a>
            </div>
            {% if recent_transactions %}
            {% for tx in recent_transactions|slice:":6" %}
            {% with system=tx.external_system %}
            <div class="system-row">
                <div class="sys-info">
                    <div class="sys-icon"><i class="fas fa-plug"></i></div>
                    <div>
                        <div class="sys-name">{{ system.name }}</div>
                        <div class="sys-type">{{ system.get_system_type_display }}</div>
                    </div>
                </div>
                <span class="status-dot-badge {{ system.connection_status }}">{{ system.get_connection_status_display }}</span>
            </div>
            {% endwith %}
            {% endfor %}
            {% else %}
            <div class="empty-msg"><i class="fas fa-plug"></i>No systems configured yet. <a href="{% url 'interoperability:external_systems_list' %}">Add a system</a></div>
            {% endif %}
        </div>

        <!-- Recent Errors Panel -->
        {% if recent_errors %}
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title" style="color:#ef4444;"><i class="fas fa-exclamation-triangle"></i> Recent Errors</div>
                <a href="{% url 'interoperability:integration_transactions_list' %}?status=failed" class="panel-action">View failed <i class="fas fa-arrow-right"></i></a>
            </div>
            {% for err in recent_errors %}
            <div class="tx-row">
                <div>
                    <div class="tx-type">{{ err.get_transaction_type_display }}</div>
                    <div class="tx-system" style="color:#ef4444;">{{ err.error_message|default:"Unknown error"|truncatechars:60 }}</div>
                    <div class="tx-system">{{ err.external_system.name }} · {{ err.started_at|date:"M d, H:i" }}</div>
                </div>
                {% if err.status_code %}
                <span style="font-size:0.875rem;font-weight:700;color:#ef4444;">{{ err.status_code }}</span>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Performance Snapshot -->
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title"><i class="fas fa-tachometer-alt" style="color:#8b5cf6;"></i> Performance (7 days)</div>
            </div>
            <div class="perf-bar" style="margin-bottom:1rem;">
                <div>
                    <div class="perf-val">{{ avg_response_time }}ms</div>
                    <div class="perf-label">Average Response Time</div>
                </div>
            </div>
            <div class="perf-bar" style="margin-bottom:1rem;">
                <div>
                    <div class="perf-val">{{ hl7_stats.processed_messages }}</div>
                    <div class="perf-label">HL7 Messages Processed</div>
                </div>
            </div>
            <div class="perf-bar">
                <div>
                    <div class="perf-val">{{ fhir_stats.total_resources }}</div>
                    <div class="perf-label">Total FHIR Resources Synced</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}