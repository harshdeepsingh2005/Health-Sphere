{% extends 'base.html' %}
{% load static %}

{% block title %}Consent Management — Interoperability | HealthSphere AI{% endblock %}

{% block extra_css %}
<style>
.page-header-bar { display:flex; align-items:center; justify-content:space-between; margin-bottom:1.75rem; flex-wrap:wrap; gap:1rem; }
.page-title-group h1 { font-size:1.5rem; font-weight:700; color:#1e293b; margin:0 0 2px; }
.page-title-group p { font-size:0.875rem; color:#64748b; margin:0; }
.filter-bar { display:flex; gap:0.75rem; flex-wrap:wrap; align-items:center; background:white; border:1px solid #e2e8f0; border-radius:14px; padding:1rem 1.25rem; margin-bottom:1.5rem; box-shadow:0 1px 4px rgba(0,0,0,0.04); }
.filter-bar form { display:flex; gap:0.75rem; flex-wrap:wrap; width:100%; align-items:center; }
.filter-search { flex:1; min-width:200px; display:flex; align-items:center; gap:0.5rem; background:#f8fafc; border:1px solid #e2e8f0; border-radius:10px; padding:0.5rem 0.875rem; }
.filter-search i { color:#94a3b8; font-size:14px; }
.filter-search input { border:none; background:transparent; outline:none; font-size:0.875rem; color:#1e293b; width:100%; }
.filter-select { padding:0.5rem 0.875rem; border:1px solid #e2e8f0; border-radius:10px; background:#f8fafc; font-size:0.875rem; color:#1e293b; outline:none; cursor:pointer; }
.btn-filter { display:inline-flex; align-items:center; gap:0.375rem; padding:0.5rem 1rem; background:#3b82f6; color:white; border:none; border-radius:10px; font-size:0.875rem; font-weight:600; cursor:pointer; text-decoration:none; transition:all 0.15s ease; }
.btn-filter:hover { background:#2563eb; transform:translateY(-1px); }
.btn-filter-secondary { background:white; color:#64748b; border:1px solid #e2e8f0; }
.btn-filter-secondary:hover { background:#f8fafc; color:#1e293b; }

.data-table-wrap { background:white; border:1px solid #e2e8f0; border-radius:16px; overflow:hidden; box-shadow:0 1px 4px rgba(0,0,0,0.04); }
.data-table { width:100%; border-collapse:collapse; }
.data-table thead th { padding:0.875rem 1.25rem; text-align:left; font-size:0.75rem; font-weight:700; text-transform:uppercase; letter-spacing:0.06em; color:#64748b; background:#f8fafc; border-bottom:1px solid #e2e8f0; white-space:nowrap; }
.data-table tbody tr { border-bottom:1px solid #f1f5f9; transition:background 0.1s; }
.data-table tbody tr:hover { background:#f8fafc; }
.data-table tbody tr:last-child { border-bottom:none; }
.data-table td { padding:0.875rem 1.25rem; font-size:0.875rem; color:#334155; vertical-align:middle; }

.badge { display:inline-flex; align-items:center; gap:4px; padding:3px 10px; border-radius:999px; font-size:0.75rem; font-weight:600; }
.badge-granted { background:rgba(16,185,129,0.1); color:#10b981; }
.badge-denied { background:rgba(239,68,68,0.1); color:#ef4444; }
.badge-withdrawn { background:rgba(245,158,11,0.1); color:#f59e0b; }
.badge-expired { background:rgba(100,116,139,0.1); color:#64748b; }
.badge-pending { background:rgba(59,130,246,0.1); color:#3b82f6; }

.patient-avatar { width:32px; height:32px; border-radius:50%; background:linear-gradient(135deg,#3b82f6,#8b5cf6); color:white; font-size:12px; font-weight:700; display:inline-flex; align-items:center; justify-content:center; margin-right:8px; flex-shrink:0; }
.patient-cell { display:flex; align-items:center; }
.patient-name { font-weight:600; color:#1e293b; font-size:0.875rem; }
.patient-email { font-size:0.75rem; color:#64748b; }

.empty-state { text-align:center; padding:4rem 2rem; }
.empty-state i { font-size:3rem; color:#cbd5e1; margin-bottom:1rem; display:block; }
.empty-state h3 { font-size:1.125rem; color:#334155; margin-bottom:0.5rem; }
.empty-state p { color:#64748b; font-size:0.875rem; margin:0; }

.consent-type-chip { display:inline-flex; align-items:center; gap:4px; padding:3px 10px; border-radius:8px; font-size:0.75rem; font-weight:600; background:#f1f5f9; color:#475569; }
</style>
{% endblock %}

{% block breadcrumb %}
<nav class="breadcrumb">
    <ol class="breadcrumb-list">
        <li class="breadcrumb-item"><a href="{% url 'interoperability:dashboard' %}" class="breadcrumb-link"><i class="fas fa-exchange-alt"></i> Interoperability</a></li>
        <li class="breadcrumb-item"><span class="breadcrumb-current">Consent Management</span></li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="page-header-bar">
    <div class="page-title-group">
        <h1><i class="fas fa-shield-alt" style="color:#10b981;margin-right:8px;"></i>Consent Management</h1>
        <p>HIPAA &amp; GDPR compliant patient data sharing consent records</p>
    </div>
</div>

<!-- Filter Bar -->
<div class="filter-bar">
    <form method="get" action="">
        <div class="filter-search">
            <i class="fas fa-search"></i>
            <input type="text" name="q" placeholder="Search by patient name or purpose…" value="{{ search_query|default:'' }}">
        </div>
        <select name="type" class="filter-select">
            <option value="">All Consent Types</option>
            {% for value, label in consent_type_choices %}
            <option value="{{ value }}" {% if consent_type == value %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
        </select>
        <select name="status" class="filter-select">
            <option value="">All Statuses</option>
            {% for value, label in status_choices %}
            <option value="{{ value }}" {% if status == value %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
        </select>
        <button type="submit" class="btn-filter"><i class="fas fa-filter"></i> Filter</button>
        {% if consent_type or status or search_query %}
        <a href="{% url 'interoperability:consent_management_list' %}" class="btn-filter btn-filter-secondary"><i class="fas fa-times"></i> Clear</a>
        {% endif %}
    </form>
</div>

{% if consents %}
<div class="data-table-wrap">
    <table class="data-table">
        <thead>
            <tr>
                <th>Patient</th>
                <th>Consent Type</th>
                <th>Purpose</th>
                <th>Status</th>
                <th>Authorized Systems</th>
                <th>Granted</th>
                <th>Expires</th>
            </tr>
        </thead>
        <tbody>
            {% for consent in consents %}
            <tr>
                <td>
                    <div class="patient-cell">
                        <span class="patient-avatar">{{ consent.patient.first_name|first|default:'?' }}{{ consent.patient.last_name|first|default:'?' }}</span>
                        <div>
                            <div class="patient-name">{{ consent.patient.get_full_name|default:consent.patient.username }}</div>
                            <div class="patient-email">{{ consent.patient.email }}</div>
                        </div>
                    </div>
                </td>
                <td>
                    <span class="consent-type-chip">
                        {% if consent.consent_type == 'treatment' %}<i class="fas fa-stethoscope"></i>
                        {% elif consent.consent_type == 'research' %}<i class="fas fa-microscope"></i>
                        {% elif consent.consent_type == 'hie' %}<i class="fas fa-network-wired"></i>
                        {% elif consent.consent_type == 'data_sharing' %}<i class="fas fa-share-alt"></i>
                        {% else %}<i class="fas fa-file-alt"></i>{% endif %}
                        {{ consent.get_consent_type_display }}
                    </span>
                </td>
                <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="{{ consent.purpose }}">
                    {{ consent.purpose|truncatechars:60 }}
                </td>
                <td>
                    <span class="badge badge-{{ consent.status }}">
                        {% if consent.status == 'granted' %}<i class="fas fa-check-circle"></i>
                        {% elif consent.status == 'denied' %}<i class="fas fa-times-circle"></i>
                        {% elif consent.status == 'withdrawn' %}<i class="fas fa-undo"></i>
                        {% elif consent.status == 'expired' %}<i class="fas fa-clock"></i>
                        {% else %}<i class="fas fa-hourglass-half"></i>{% endif %}
                        {{ consent.get_status_display }}
                    </span>
                </td>
                <td>
                    {% with systems=consent.authorized_systems.all %}
                    {% if systems %}
                    <span style="font-size:0.8125rem;color:#334155;">{{ systems|length }} system{{ systems|pluralize }}</span>
                    {% else %}
                    <span style="color:#94a3b8;font-size:0.8125rem;">None</span>
                    {% endif %}
                    {% endwith %}
                </td>
                <td style="font-size:0.8125rem;color:#64748b;">
                    {% if consent.granted_at %}{{ consent.granted_at|date:"M d, Y" }}{% else %}<span style="color:#94a3b8;">—</span>{% endif %}
                </td>
                <td style="font-size:0.8125rem;">
                    {% if consent.expires_at %}
                    <span style="{% if consent.expires_at < now %}color:#ef4444;{% else %}color:#64748b;{% endif %}">
                        {{ consent.expires_at|date:"M d, Y" }}
                    </span>
                    {% else %}<span style="color:#94a3b8;">No expiry</span>{% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if consents.has_other_pages %}
<div style="display:flex;justify-content:center;gap:0.5rem;margin-top:1.5rem;">
    {% if consents.has_previous %}<a href="?page={{ consents.previous_page_number }}" class="btn-filter btn-filter-secondary"><i class="fas fa-chevron-left"></i></a>{% endif %}
    <span style="padding:6px 16px;background:white;border:1px solid #e2e8f0;border-radius:10px;font-size:0.875rem;color:#64748b;">Page {{ consents.number }} of {{ consents.paginator.num_pages }}</span>
    {% if consents.has_next %}<a href="?page={{ consents.next_page_number }}" class="btn-filter"><i class="fas fa-chevron-right"></i></a>{% endif %}
</div>
{% endif %}

{% else %}
<div class="data-table-wrap">
    <div class="empty-state">
        <i class="fas fa-shield-alt"></i>
        <h3>No consent records found</h3>
        <p>{% if consent_type or status or search_query %}No records match your current filters.{% else %}No patient consent records have been created yet.{% endif %}</p>
    </div>
</div>
{% endif %}
{% endblock %}