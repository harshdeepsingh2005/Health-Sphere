{% extends "base.html" %}
{% load static %}

{% block title %}{{ patient.get_full_name }} â€” Clinical Portal | HealthSphere AI{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'clinical_portal:dashboard' %}" class="breadcrumb-link">Dashboard</a></li>
<li class="breadcrumb-item"><a href="{% url 'clinical_portal:patients' %}" class="breadcrumb-link">Patients</a></li>
<li class="breadcrumb-item breadcrumb-current">{{ patient.get_full_name }}</li>
{% endblock %}

{% block extra_css %}
<style>
/* â”€â”€â”€ Hero â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.patient-hero {
  background: linear-gradient(135deg,#1e293b,#334155);
  border-radius: var(--radius-xl);
  padding: 2rem;
  display: flex; align-items: center; gap: 1.5rem;
  margin-bottom: 1.75rem; color: white;
}
.hero-avatar {
  width:80px;height:80px;border-radius:50%;
  background:linear-gradient(135deg,#3b82f6,#8b5cf6);
  display:flex;align-items:center;justify-content:center;
  font-size:1.75rem;font-weight:800;flex-shrink:0;
}
.hero-name{font-size:1.5rem;font-weight:700;}
.hero-meta{margin-top:.35rem;opacity:.7;font-size:.9rem;}
.hero-cta{margin-left:auto;display:flex;gap:.75rem;flex-shrink:0;flex-wrap:wrap;}
.hero-btn{
  padding:.55rem 1.125rem;border-radius:var(--radius-lg);
  font-size:.875rem;font-weight:600;text-decoration:none;
  cursor:pointer;border:none;transition:all .2s;
  display:inline-flex;align-items:center;gap:.4rem;
}
.hero-btn-primary  {background:var(--healthcare-primary);color:white;}
.hero-btn-success  {background:#10b981;color:white;}
.hero-btn-warning  {background:#f59e0b;color:white;}
.hero-btn-danger   {background:#ef4444;color:white;}
.hero-btn-outline  {background:rgba(255,255,255,.1);color:white;border:1px solid rgba(255,255,255,.25);}
.hero-btn:hover    {opacity:.9;transform:translateY(-1px);}

/* â”€â”€â”€ Info grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:1.25rem;}
.info-card{
  background:white;border:1px solid var(--neutral-100);
  border-radius:var(--radius-xl);padding:1.25rem;
  box-shadow:0 1px 5px rgba(0,0,0,.04);
}
.info-card h3{
  font-size:.9375rem;font-weight:700;color:var(--neutral-800);
  margin:0 0 1rem;display:flex;align-items:center;gap:.5rem;
}
.info-card h3 i{color:var(--healthcare-primary);}
.data-row{
  display:flex;justify-content:space-between;
  padding:.45rem 0;border-bottom:1px solid var(--neutral-50);font-size:.875rem;
}
.data-row:last-child{border-bottom:none;}
.data-row .key{color:var(--neutral-500);}
.data-row .val{color:var(--neutral-800);font-weight:500;}
.empty-card{text-align:center;padding:1.5rem;color:var(--neutral-400);font-size:.875rem;}
.record-item,.plan-item,.vital-item{
  padding:.6rem .75rem;border-radius:var(--radius-md);
  border:1px solid var(--neutral-100);margin-bottom:.35rem;
  display:flex;justify-content:space-between;align-items:center;
}
.record-item:hover,.plan-item:hover,.vital-item:hover{background:var(--neutral-50);}
a.item-link{text-decoration:none;color:inherit;}
.badge{
  display:inline-flex;align-items:center;gap:.3rem;
  padding:.15rem .5rem;border-radius:999px;font-size:.7rem;font-weight:700;
}
.badge-admitted  {background:rgba(16,185,129,.12);color:#059669;}
.badge-discharged{background:rgba(100,116,139,.1);color:#64748b;}
.badge-active    {background:rgba(59,130,246,.12);color:#2563eb;}

/* â”€â”€â”€ Discharge warning banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.discharge-banner{
  border-radius:var(--radius-lg);padding:1rem 1.25rem;
  background:rgba(16,185,129,.07);border:1px dashed rgba(16,185,129,.4);
  display:flex;align-items:center;gap:.75rem;font-size:.875rem;
  color:#065f46;margin-bottom:1.5rem;
}
.discharge-banner i{color:#059669;font-size:1.1rem;}

/* â”€â”€â”€ Modal overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.modal-overlay{
  position:fixed;inset:0;z-index:99999;
  background:rgba(15,23,42,.55);backdrop-filter:blur(4px);
  display:flex;align-items:center;justify-content:center;
  /* offset from the fixed sidebar so the modal centres in the content area */
  padding-left:260px;
  opacity:0;pointer-events:none;transition:opacity .25s;
}
.modal-overlay.open{opacity:1;pointer-events:all;}
.modal-box{
  background:white;border-radius:20px;width:95%;max-width:640px;
  max-height:92vh;overflow-y:auto;
  box-shadow:0 24px 64px rgba(0,0,0,.25);
  transform:translateY(24px);transition:transform .28s cubic-bezier(.34,1.56,.64,1);
}
.modal-overlay.open .modal-box{transform:translateY(0);}
/* collapsed/mobile sidebar â€” remove offset */
@media(max-width:900px){
  .modal-overlay{padding-left:0;}
}
.modal-header{
  padding:1.25rem 1.5rem;border-bottom:1px solid var(--neutral-100);
  display:flex;align-items:center;justify-content:space-between;
}
.modal-header h2{font-size:1.05rem;font-weight:700;color:var(--neutral-900);margin:0;}
.modal-close{
  background:none;border:none;font-size:1.2rem;cursor:pointer;
  color:var(--neutral-400);line-height:1;padding:.25rem .5rem;
  transition:color .15s;
}
.modal-close:hover{color:var(--neutral-700);}
.modal-body{padding:1.5rem;}
.modal-footer{
  padding:1rem 1.5rem;border-top:1px solid var(--neutral-100);
  display:flex;justify-content:flex-end;gap:.75rem;
}

/* â”€â”€â”€ Form fields inside modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.field-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem;}
.field-grid.full{grid-template-columns:1fr;}
.field-group{display:flex;flex-direction:column;gap:.35rem;}
.field-group label{font-size:.8rem;font-weight:600;color:var(--neutral-600);}
.field-group input,.field-group select,.field-group textarea{
  border:1px solid var(--neutral-200);border-radius:10px;
  padding:.6rem .85rem;font-size:.875rem;outline:none;
  transition:border-color .15s;font-family:inherit;
}
.field-group input:focus,.field-group select:focus,.field-group textarea:focus{
  border-color:var(--healthcare-primary);
}
.section-divider{
  margin:1.25rem 0 .75rem;font-size:.75rem;font-weight:700;
  color:var(--neutral-500);text-transform:uppercase;letter-spacing:.04em;
  border-bottom:1px solid var(--neutral-100);padding-bottom:.4rem;
}
.btn{
  padding:.55rem 1.125rem;border-radius:var(--radius-lg);
  font-size:.875rem;font-weight:600;cursor:pointer;border:none;
  transition:all .2s;
}
.btn-primary{background:var(--healthcare-primary);color:white;}
.btn-danger{background:#ef4444;color:white;}
.btn-ghost{background:var(--neutral-100);color:var(--neutral-700);}
.btn:hover{opacity:.9;transform:translateY(-1px);}

/* â”€â”€â”€ Alert messages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.alert{
  padding:.75rem 1rem;border-radius:10px;margin-bottom:1rem;
  font-size:.875rem;display:flex;align-items:center;gap:.6rem;
}
.alert-success{background:#d1fae5;color:#065f46;border:1px solid rgba(16,185,129,.2);}
.alert-error  {background:#fee2e2;color:#991b1b;border:1px solid rgba(239,68,68,.2);}
</style>
{% endblock %}

{% block content %}

{% if messages %}
{% for msg in messages %}
<div class="alert {% if msg.tags == 'error' %}alert-error{% else %}alert-success{% endif %}">
  <i class="fas {% if msg.tags == 'error' %}fa-exclamation-circle{% else %}fa-check-circle{% endif %}"></i>
  {{ msg }}
</div>
{% endfor %}
{% endif %}

{% with active_admission=admissions.0 %}

{% if active_admission and active_admission.status == 'admitted' %}
<div class="discharge-banner">
  <i class="fas fa-hospital-user"></i>
  <span><strong>Currently Admitted</strong> â€” {{ active_admission.get_admission_type_display }} since {{ active_admission.admission_date|date:"d M Y, g:i A" }}
  {% if active_admission.ward %}Â· Ward {{ active_admission.ward }}{% endif %}
  {% if active_admission.room_number %}Â· Room {{ active_admission.room_number }}{% endif %}
  </span>
</div>
{% endif %}

{# â”€â”€ Hero â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
<div class="patient-hero">
  <div class="hero-avatar">
    {{ patient.first_name|first|upper }}{{ patient.last_name|first|upper }}
  </div>
  <div>
    <div class="hero-name">{{ patient.get_full_name|default:patient.username }}</div>
    <div class="hero-meta">
      {{ patient.email }} Â· {{ patient.phone|default:"No phone" }}
      {% if patient.profile.blood_type %}Â· ðŸ©¸ {{ patient.profile.blood_type }}{% endif %}
    </div>
  </div>
  <div class="hero-cta">
    <button class="hero-btn hero-btn-warning" onclick="openModal('edit-modal')">
      <i class="fas fa-user-edit"></i> Edit Patient
    </button>
    {% if active_admission and active_admission.status == 'admitted' %}
    <button class="hero-btn hero-btn-success" onclick="openModal('discharge-modal')">
      <i class="fas fa-sign-out-alt"></i> Discharge
    </button>
    {% endif %}
    <a href="{% url 'clinical_portal:risk' %}?patient_id={{ patient.id }}" class="hero-btn hero-btn-primary">
      <i class="fas fa-heartbeat"></i> Risk
    </a>
    <a href="{% url 'clinical_portal:patient_vitals' patient.id %}" class="hero-btn hero-btn-outline">
      <i class="fas fa-chart-line"></i> Vitals
    </a>
  </div>
</div>

{# â”€â”€ Patient Details Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
<div class="info-grid" style="margin-bottom:1.25rem;">

  {# Personal Info #}
  <div class="info-card">
    <h3><i class="fas fa-id-card"></i> Personal Information</h3>
    <div class="data-row"><span class="key">Full Name</span><span class="val">{{ patient.get_full_name }}</span></div>
    <div class="data-row"><span class="key">Email</span><span class="val">{{ patient.email }}</span></div>
    <div class="data-row"><span class="key">Phone</span><span class="val">{{ patient.phone|default:"â€”" }}</span></div>
    <div class="data-row"><span class="key">Date of Birth</span><span class="val">{{ patient.date_of_birth|date:"d M Y"|default:"â€”" }}</span></div>
    <div class="data-row"><span class="key">Username</span><span class="val">{{ patient.username }}</span></div>
    <div class="data-row"><span class="key">Joined</span><span class="val">{{ patient.date_joined|date:"d M Y" }}</span></div>
  </div>

  {# Medical Profile #}
  <div class="info-card">
    <h3><i class="fas fa-stethoscope"></i> Medical Profile</h3>
    <div class="data-row"><span class="key">Blood Type</span><span class="val">{{ patient.profile.blood_type|default:"â€”" }}</span></div>
    <div class="data-row"><span class="key">Allergies</span><span class="val">{{ patient.profile.allergies|default:"None recorded" }}</span></div>
    <div class="data-row"><span class="key">Emergency Contact</span><span class="val">{{ patient.profile.emergency_contact_name|default:"â€”" }}</span></div>
    <div class="data-row"><span class="key">Emergency Phone</span><span class="val">{{ patient.profile.emergency_contact_phone|default:"â€”" }}</span></div>
    {% if patient.profile.medical_notes %}
    <div class="data-row" style="flex-direction:column;gap:.25rem;">
      <span class="key">Medical Notes</span>
      <span class="val" style="font-size:.8rem;line-height:1.5;">{{ patient.profile.medical_notes }}</span>
    </div>
    {% endif %}
  </div>

</div>

{# â”€â”€ Clinical Data Grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
<div class="info-grid">

  {# Recent Records #}
  <div class="info-card">
    <h3><i class="fas fa-file-medical-alt"></i> Recent Medical Records
      <a href="{% url 'clinical_portal:records' %}?patient_id={{ patient.id }}"
         style="margin-left:auto;font-size:.75rem;color:var(--healthcare-primary);font-weight:600;text-decoration:none;">All â†’</a>
    </h3>
    {% for record in records %}
    <a href="{% url 'clinical_portal:record_detail' record.pk %}" class="item-link">
      <div class="record-item">
        <div>
          <div style="font-weight:600;font-size:.875rem;color:var(--neutral-900);">{{ record.title }}</div>
          <div style="font-size:.75rem;color:var(--neutral-500);">{{ record.record_date|date:"M j, Y" }} Â· {{ record.get_record_type_display }}</div>
        </div>
        <span class="badge" style="background:rgba(100,116,139,.1);color:#64748b;">{{ record.get_severity_display }}</span>
      </div>
    </a>
    {% empty %}
    <div class="empty-card">No records yet</div>
    {% endfor %}
  </div>

  {# Treatment Plans #}
  <div class="info-card">
    <h3><i class="fas fa-clipboard-list"></i> Treatment Plans
      <a href="{% url 'clinical_portal:treatment_plans' %}?patient_id={{ patient.id }}"
         style="margin-left:auto;font-size:.75rem;color:var(--healthcare-primary);font-weight:600;text-decoration:none;">All â†’</a>
    </h3>
    {% for plan in plans %}
    <a href="{% url 'clinical_portal:treatment_plan_detail' plan.pk %}" class="item-link">
      <div class="plan-item">
        <div>
          <div style="font-weight:600;font-size:.875rem;color:var(--neutral-900);">{{ plan.title }}</div>
          <div style="font-size:.75rem;color:var(--neutral-500);">{{ plan.start_date }} â€” {{ plan.end_date|default:"Ongoing" }}</div>
        </div>
        <span class="badge badge-{{ plan.status }}">{{ plan.get_status_display }}</span>
      </div>
    </a>
    {% empty %}
    <div class="empty-card">No active plans</div>
    {% endfor %}
  </div>

  {# Vitals #}
  <div class="info-card">
    <h3><i class="fas fa-heartbeat"></i> Recent Vitals
      <a href="{% url 'clinical_portal:patient_vitals' patient.id %}"
         style="margin-left:auto;font-size:.75rem;color:var(--healthcare-primary);font-weight:600;text-decoration:none;">Full trend â†’</a>
    </h3>
    {% for vital in vitals %}
    <div class="vital-item">
      <div style="font-size:.8rem;color:var(--neutral-500);">{{ vital.recorded_at|date:"M j, g:i A" }}</div>
      <div style="display:flex;gap:1rem;font-size:.8rem;">
        {% if vital.heart_rate %}<span><i class="fas fa-heart" style="color:#ef4444;font-size:.65rem;"></i> {{ vital.heart_rate }} bpm</span>{% endif %}
        {% if vital.temperature %}<span><i class="fas fa-thermometer-half" style="color:#f59e0b;font-size:.65rem;"></i> {{ vital.temperature }}Â°C</span>{% endif %}
        {% if vital.oxygen_saturation %}<span><i class="fas fa-lungs" style="color:#3b82f6;font-size:.65rem;"></i> {{ vital.oxygen_saturation }}%</span>{% endif %}
      </div>
    </div>
    {% empty %}<div class="empty-card">No vitals recorded</div>{% endfor %}
  </div>

  {# Admissions #}
  <div class="info-card">
    <h3><i class="fas fa-hospital"></i> Admission History</h3>
    {% for adm in admissions %}
    <div class="vital-item">
      <div>
        <div style="font-weight:600;font-size:.875rem;color:var(--neutral-900);">{{ adm.get_admission_type_display }}</div>
        <div style="font-size:.75rem;color:var(--neutral-500);">
          {{ adm.admission_date|date:"d M Y" }} â†’ {{ adm.discharge_date|date:"d M Y"|default:"Present" }}
          ({{ adm.length_of_stay }} day{{ adm.length_of_stay|pluralize }})
        </div>
      </div>
      <span class="badge {% if adm.status == 'admitted' %}badge-admitted{% else %}badge-discharged{% endif %}">{{ adm.get_status_display }}</span>
    </div>
    {% empty %}<div class="empty-card">No admissions</div>{% endfor %}
  </div>

</div>

{# â”€â”€ Diagnostic AI (full-width) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
{% if diagnostic_ai %}
<div style="margin-top:1.5rem;">
  <div class="info-card" style="border-left:4px solid #6366f1;">
    <h3>
      <i class="fas fa-robot" style="color:#6366f1;"></i>
      AI Diagnostic Assessment
      {% if diagnostic_ai.ai_powered %}
      <span style="margin-left:auto;font-size:.7rem;font-weight:600;color:#6366f1;background:rgba(99,102,241,.08);padding:3px 10px;border-radius:20px;">
        <i class="fas fa-check-circle"></i> AI Enhanced
      </span>
      {% else %}
      <span style="margin-left:auto;font-size:.7rem;color:var(--neutral-400);padding:3px 10px;">Rule-based only</span>
      {% endif %}
    </h3>
    {% if diagnostic_ai.ai_summary %}
    <div style="margin-bottom:1rem;padding:12px 16px;border-radius:8px;background:rgba(99,102,241,0.05);border:1px solid rgba(99,102,241,0.15);font-size:.875rem;line-height:1.6;color:var(--neutral-700);">
      <div style="font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:#6366f1;margin-bottom:5px;">Clinical Summary</div>
      {{ diagnostic_ai.ai_summary }}
    </div>
    {% endif %}
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;">
      <div>
        <div style="font-size:.8rem;font-weight:700;color:var(--neutral-600);margin-bottom:.5rem;text-transform:uppercase;letter-spacing:.05em;">Differential Diagnoses</div>
        {% for dx in diagnostic_ai.differential_diagnosis %}
        <div style="padding:.5rem .75rem;border-radius:8px;border:1px solid var(--neutral-100);margin-bottom:.35rem;display:flex;justify-content:space-between;align-items:center;background:var(--neutral-50);">
          <div>
            <div style="font-weight:600;font-size:.85rem;color:var(--neutral-800);">{{ dx.diagnosis }}</div>
            <div style="font-size:.7rem;color:var(--neutral-500);">{{ dx.confidence }} confidence Â· {{ dx.severity }}</div>
          </div>
          <span style="font-weight:700;font-size:.85rem;{% if dx.probability > 40 %}color:#ef4444;{% elif dx.probability > 20 %}color:#f59e0b;{% else %}color:#10b981;{% endif %}">{{ dx.probability }}%</span>
        </div>
        {% empty %}<div class="empty-card">No differential diagnoses generated.</div>{% endfor %}
      </div>
      <div>
        {% if diagnostic_ai.risk_assessment %}
        <div style="font-size:.8rem;font-weight:700;color:var(--neutral-600);margin-bottom:.5rem;text-transform:uppercase;letter-spacing:.05em;">Risk Assessment</div>
        <div style="padding:.75rem;border-radius:8px;margin-bottom:.75rem;background:{% if diagnostic_ai.risk_assessment.risk_level == 'High' %}rgba(239,68,68,.06){% elif diagnostic_ai.risk_assessment.risk_level == 'Moderate' %}rgba(245,158,11,.06){% else %}rgba(16,185,129,.06){% endif %};border:1px solid {% if diagnostic_ai.risk_assessment.risk_level == 'High' %}rgba(239,68,68,.2){% elif diagnostic_ai.risk_assessment.risk_level == 'Moderate' %}rgba(245,158,11,.2){% else %}rgba(16,185,129,.2){% endif %};">
          <div style="font-weight:700;font-size:1.1rem;{% if diagnostic_ai.risk_assessment.risk_level == 'High' %}color:#ef4444;{% elif diagnostic_ai.risk_assessment.risk_level == 'Moderate' %}color:#f59e0b;{% else %}color:#10b981;{% endif %}">{{ diagnostic_ai.risk_assessment.risk_level }} Risk</div>
          <div style="font-size:.75rem;color:var(--neutral-500);">Score: {{ diagnostic_ai.risk_assessment.risk_score }} Â· {{ diagnostic_ai.risk_assessment.monitoring_frequency }}</div>
        </div>
        {% endif %}
        {% if diagnostic_ai.ai_next_steps %}
        <div style="font-size:.8rem;font-weight:700;color:var(--neutral-600);margin-bottom:.5rem;text-transform:uppercase;letter-spacing:.05em;">Recommended Next Steps</div>
        <ul style="margin:0;padding-left:1.1rem;">
          {% for step in diagnostic_ai.ai_next_steps %}
          <li style="font-size:.825rem;color:var(--neutral-700);padding:3px 0;">{{ step }}</li>
          {% endfor %}
        </ul>
        {% endif %}
      </div>
    </div>
    <div style="margin-top:1rem;font-size:.7rem;color:var(--neutral-400);">
      Generated by AI Â· {{ diagnostic_ai.generated_at }} Â· Version {{ diagnostic_ai.ai_version }}
    </div>
  </div>
</div>
{% endif %}

{% endwith %}

{# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
{# MODAL 1: Edit Patient Details                                   #}
{# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
<div class="modal-overlay" id="edit-modal">
  <div class="modal-box">
    <div class="modal-header">
      <h2><i class="fas fa-user-edit" style="color:var(--healthcare-primary);margin-right:.5rem;"></i>Edit Patient Details</h2>
      <button class="modal-close" onclick="closeModal('edit-modal')">&times;</button>
    </div>
    <form method="POST" action="{% url 'clinical_portal:edit_patient' patient.id %}">
      {% csrf_token %}
      <div class="modal-body">

        <div class="section-divider">Personal Information</div>
        <div class="field-grid">
          <div class="field-group">
            <label>First Name</label>
            <input type="text" name="first_name" value="{{ patient.first_name }}" required>
          </div>
          <div class="field-group">
            <label>Last Name</label>
            <input type="text" name="last_name" value="{{ patient.last_name }}" required>
          </div>
          <div class="field-group">
            <label>Email</label>
            <input type="email" name="email" value="{{ patient.email }}">
          </div>
          <div class="field-group">
            <label>Phone</label>
            <input type="tel" name="phone" value="{{ patient.phone|default:'' }}">
          </div>
          <div class="field-group">
            <label>Date of Birth</label>
            <input type="date" name="date_of_birth" value="{{ patient.date_of_birth|date:'Y-m-d'|default:'' }}">
          </div>
          <div class="field-group">
            <label>Blood Type</label>
            <select name="blood_type">
              <option value="">â€” Select â€”</option>
              {% with bt=patient.profile.blood_type %}
              <option value="A+"  {% if bt == "A+"  %}selected{% endif %}>A+</option>
              <option value="A-"  {% if bt == "A-"  %}selected{% endif %}>A-</option>
              <option value="B+"  {% if bt == "B+"  %}selected{% endif %}>B+</option>
              <option value="B-"  {% if bt == "B-"  %}selected{% endif %}>B-</option>
              <option value="AB+" {% if bt == "AB+" %}selected{% endif %}>AB+</option>
              <option value="AB-" {% if bt == "AB-" %}selected{% endif %}>AB-</option>
              <option value="O+"  {% if bt == "O+"  %}selected{% endif %}>O+</option>
              <option value="O-"  {% if bt == "O-"  %}selected{% endif %}>O-</option>
              {% endwith %}
            </select>
          </div>
        </div>

        <div class="section-divider">Medical Profile</div>
        <div class="field-grid full">
          <div class="field-group">
            <label>Allergies</label>
            <textarea name="allergies" rows="2" placeholder="e.g. Penicillin, Peanuts">{{ patient.profile.allergies|default:'' }}</textarea>
          </div>
          <div class="field-group">
            <label>Medical Notes</label>
            <textarea name="medical_notes" rows="2" placeholder="Any relevant medical history or notes">{{ patient.profile.medical_notes|default:'' }}</textarea>
          </div>
        </div>

        <div class="section-divider">Emergency Contact</div>
        <div class="field-grid">
          <div class="field-group">
            <label>Contact Name</label>
            <input type="text" name="emergency_contact_name" value="{{ patient.profile.emergency_contact_name|default:'' }}" placeholder="e.g. Jane Smith">
          </div>
          <div class="field-group">
            <label>Contact Phone</label>
            <input type="tel" name="emergency_contact_phone" value="{{ patient.profile.emergency_contact_phone|default:'' }}" placeholder="+91 98765 43210">
          </div>
        </div>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-ghost" onclick="closeModal('edit-modal')">Cancel</button>
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-save"></i> Save Changes
        </button>
      </div>
    </form>
  </div>
</div>

{# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
{# MODAL 2: Discharge Form                                         #}
{# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
{% with active_admission=admissions.0 %}
{% if active_admission and active_admission.status == 'admitted' %}
<div class="modal-overlay" id="discharge-modal">
  <div class="modal-box">
    <div class="modal-header">
      <h2><i class="fas fa-sign-out-alt" style="color:#10b981;margin-right:.5rem;"></i>Discharge Patient</h2>
      <button class="modal-close" onclick="closeModal('discharge-modal')">&times;</button>
    </div>
    <form method="POST" action="{% url 'clinical_portal:discharge_patient' patient.id %}">
      {% csrf_token %}
      <div class="modal-body">

        <div style="background:rgba(16,185,129,.06);border:1px solid rgba(16,185,129,.2);border-radius:10px;padding:.85rem 1rem;font-size:.875rem;color:#065f46;margin-bottom:1.25rem;">
          <i class="fas fa-info-circle"></i>
          Discharging <strong>{{ patient.get_full_name }}</strong> â€” admitted {{ active_admission.admission_date|date:"d M Y" }}
          ({{ active_admission.length_of_stay }} day{{ active_admission.length_of_stay|pluralize }}). A discharge summary record will be created automatically.
        </div>

        <div class="field-grid full" style="gap:.9rem;">
          <div class="field-group">
            <label>Discharge Type <span style="color:#ef4444;">*</span></label>
            <select name="discharge_type" required>
              <option value="discharged">Discharged â€” Home</option>
              <option value="transferred">Transferred to another facility</option>
            </select>
          </div>
          <div class="field-group">
            <label>Primary Diagnosis at Discharge</label>
            <input type="text" name="discharge_diagnosis" placeholder="e.g. Hypertensive crisis, resolved">
          </div>
          <div class="field-group">
            <label>Discharge Summary <span style="color:#ef4444;">*</span></label>
            <textarea name="discharge_summary" rows="4" required
              placeholder="Summarise the patient's hospital stay, treatment given, and condition at dischargeâ€¦"></textarea>
          </div>
          <div class="field-group">
            <label>Follow-up Instructions</label>
            <textarea name="follow_up_instructions" rows="3"
              placeholder="e.g. Return in 2 weeks, continue medication X, avoid strenuous activityâ€¦"></textarea>
          </div>
        </div>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-ghost" onclick="closeModal('discharge-modal')">Cancel</button>
        <button type="submit" class="btn btn-danger"
          onclick="return confirm('Confirm discharge of {{ patient.get_full_name }}?');">
          <i class="fas fa-sign-out-alt"></i> Confirm Discharge
        </button>
      </div>
    </form>
  </div>
</div>
{% endif %}
{% endwith %}

{% endblock %}

{% block extra_js %}
<script>
function openModal(id) {
  document.getElementById(id).classList.add('open');
  document.body.style.overflow = 'hidden';
}
function closeModal(id) {
  document.getElementById(id).classList.remove('open');
  document.body.style.overflow = '';
}
// Close on backdrop click
document.querySelectorAll('.modal-overlay').forEach(function(overlay) {
  overlay.addEventListener('click', function(e) {
    if (e.target === overlay) closeModal(overlay.id);
  });
});
// Close on Escape
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    document.querySelectorAll('.modal-overlay.open').forEach(function(m) {
      closeModal(m.id);
    });
  }
});
</script>
{% endblock %}
