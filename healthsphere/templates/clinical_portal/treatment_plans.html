{% extends "base.html" %}
{% load static %}

{% block title %}Treatment Plans — Clinical Portal | HealthSphere AI{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'clinical_portal:dashboard' %}" class="breadcrumb-link">Dashboard</a></li>
<li class="breadcrumb-item breadcrumb-current">Treatment Plans</li>
{% endblock %}

{% block extra_css %}
<style>
.page-header { margin-bottom: 1.5rem; }
.page-header h1 { font-size: 1.75rem; font-weight: 700; color: var(--neutral-900); margin: 0; }
.page-header p { color: var(--neutral-500); margin: .25rem 0 0; }

.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
.stat-card {
    background: white; border: 1px solid var(--neutral-100);
    border-radius: var(--radius-xl); padding: 1.25rem;
    text-align: center; box-shadow: 0 1px 6px rgba(0,0,0,.04);
}
.stat-card .stat-value { font-size: 2rem; font-weight: 800; color: var(--neutral-900); }
.stat-card .stat-label { font-size: .8125rem; color: var(--neutral-500); margin-top: .25rem; }
.stat-card.danger .stat-value { color: var(--healthcare-danger); }
.stat-card.success .stat-value { color: var(--healthcare-success); }
.stat-card.warning .stat-value { color: var(--healthcare-warning); }

.filter-row { display: flex; gap: .75rem; flex-wrap: wrap; margin-bottom: 1.5rem; }
.filter-select { padding: .5rem .875rem; border: 1px solid var(--neutral-200); border-radius: var(--radius-lg); background: white; color: var(--neutral-700); font-size: .875rem; }
.search-box { display: flex; align-items: center; gap: .5rem; background: white; border: 1px solid var(--neutral-200); border-radius: var(--radius-lg); padding: .5rem 1rem; flex: 1; min-width: 220px; }
.search-box input { border: none; outline: none; width: 100%; font-size: .875rem; }
.btn-filter { padding: .5rem 1rem; border-radius: var(--radius-lg); border: none; cursor: pointer; font-size: .875rem; font-weight: 500; }
.btn-apply { background: var(--healthcare-primary); color: white; }
.btn-clear { background: var(--neutral-100); color: var(--neutral-700); text-decoration: none; display: inline-flex; align-items: center; gap: .3rem; }

.plans-list { display: flex; flex-direction: column; gap: .875rem; }
.plan-card {
    background: white; border: 1px solid var(--neutral-100);
    border-radius: var(--radius-xl); padding: 1.25rem;
    display: flex; align-items: flex-start; gap: 1rem;
    box-shadow: 0 1px 5px rgba(0,0,0,.04);
    transition: all .2s;
}
.plan-card:hover { transform: translateX(3px); box-shadow: 0 4px 16px rgba(0,0,0,.08); }
.plan-icon {
    width: 44px; height: 44px; border-radius: var(--radius-lg);
    background: linear-gradient(135deg, var(--healthcare-primary), var(--healthcare-accent));
    display: flex; align-items: center; justify-content: center;
    color: white; font-size: 1.1rem; flex-shrink: 0;
}
.plan-body { flex: 1; min-width: 0; }
.plan-title { font-size: .9375rem; font-weight: 600; color: var(--neutral-900); }
.plan-patient { font-size: .8125rem; color: var(--neutral-500); margin-top: .15rem; }
.plan-diagnosis { font-size: .8125rem; color: var(--neutral-600); margin-top: .4rem; }
.plan-meta { display: flex; gap: 1rem; margin-top: .5rem; flex-wrap: wrap; }
.plan-meta-item { font-size: .75rem; color: var(--neutral-500); display: flex; align-items: center; gap: .3rem; }

.status-badge { display: inline-flex; align-items: center; gap: .3rem; padding: .25rem .7rem; border-radius: 999px; font-size: .7rem; font-weight: 700; }
.status-active    { background: rgba(16,185,129,.12); color: #059669; }
.status-completed { background: rgba(59,130,246,.12);  color: #2563eb; }
.status-draft     { background: rgba(100,116,139,.1);  color: #64748b; }
.status-cancelled { background: rgba(239,68,68,.1);    color: #dc2626; }

a.view-link { color: var(--healthcare-primary); font-size: .8125rem; font-weight: 500; text-decoration: none; white-space: nowrap; }
a.view-link:hover { text-decoration: underline; }

.empty-state { text-align: center; padding: 3rem; color: var(--neutral-500); }

/* ---- Modal ---- */
.modal-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,.45); z-index: 1050;
    align-items: flex-start; justify-content: center; padding-top: 60px;
}
.modal-overlay.open { display: flex; }
.modal-box {
    background: white; border-radius: 20px; padding: 2rem;
    width: 100%; max-width: 640px; max-height: 86vh; overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0,0,0,.2);
    animation: slideDown .25s ease;
}
@keyframes slideDown { from { opacity:0; transform: translateY(-20px); } to { opacity:1; transform:none; } }
.modal-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--neutral-100);
}
.modal-header h2 { font-size: 1.2rem; font-weight: 700; color: var(--neutral-900); margin: 0; }
.modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--neutral-400); line-height: 1; padding: 0; }
.modal-close:hover { color: var(--neutral-700); }
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
.form-group { display: flex; flex-direction: column; gap: .35rem; }
.form-group.full { grid-column: 1/-1; }
.form-label { font-size: .8125rem; font-weight: 600; color: var(--neutral-700); }
.form-label span { color: #ef4444; }
.form-control {
    padding: .6rem .875rem; border: 1.5px solid var(--neutral-200);
    border-radius: var(--radius-lg); font-size: .875rem; color: var(--neutral-800);
    outline: none; transition: all .15s; background: white;
}
.form-control:focus { border-color: var(--healthcare-primary); box-shadow: 0 0 0 3px rgba(37,99,235,.1); }
.form-actions {
    display: flex; justify-content: flex-end; gap: .75rem;
    margin-top: 1.5rem; padding-top: 1.25rem; border-top: 1px solid var(--neutral-100);
}
.btn-cancel, .btn-submit {
    padding: .6rem 1.25rem; border-radius: var(--radius-lg);
    font-size: .875rem; font-weight: 600; cursor: pointer; transition: all .15s;
}
.btn-cancel { background: white; border: 1px solid var(--neutral-200); color: var(--neutral-600); }
.btn-cancel:hover { background: var(--neutral-50); color: var(--neutral-900); border-color: var(--neutral-300); }
.btn-submit { background: var(--healthcare-primary); border: none; color: white; display: inline-flex; align-items: center; gap: .4rem; }
.btn-submit:hover { background: var(--healthcare-primary-dark); }
</style>
{% endblock %}

{% block content %}
<div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 1rem;">
    <div>
        <h1><i class="fas fa-clipboard-list" style="color: var(--healthcare-success); margin-right: .5rem;"></i>Treatment Plans</h1>
        <p>Review and manage all patient treatment plans and care protocols</p>
    </div>
    <button id="openPlanModalBtn" class="btn-submit" style="padding: .6rem 1.25rem; border-radius: var(--radius-lg); font-size: .875rem; font-weight: 600; cursor: pointer; background: var(--healthcare-primary); border: none; color: white; display: inline-flex; align-items: center; gap: .4rem;">
        <i class="fas fa-plus"></i> Add Plan
    </button>
</div>

<!-- Stats -->
<div class="stats-grid">
    <div class="stat-card success">
        <div class="stat-value">{{ stats.active }}</div>
        <div class="stat-label">Active Plans</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ stats.completed }}</div>
        <div class="stat-label">Completed</div>
    </div>
    <div class="stat-card warning">
        <div class="stat-value">{{ stats.pending_review }}</div>
        <div class="stat-label">Pending Review</div>
    </div>
</div>

<!-- Filters -->
<form method="get" class="filter-row">
    <div class="search-box">
        <i class="fas fa-search" style="color: var(--neutral-400);"></i>
        <input type="text" name="search" placeholder="Search plans…" value="{{ search_query }}">
    </div>
    <select name="status" class="filter-select">
        <option value="">All statuses</option>
        {% for val, label in status_choices %}
        <option value="{{ val }}" {% if selected_status == val %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
    </select>
    <select name="patient_id" class="filter-select">
        <option value="">All patients</option>
        {% for p in patients %}
        <option value="{{ p.id }}" {% if selected_patient == p.id|stringformat:"s" %}selected{% endif %}>
            {{ p.get_full_name|default:p.username }}
        </option>
        {% endfor %}
    </select>
    <button type="submit" class="btn-filter btn-apply"><i class="fas fa-filter"></i> Filter</button>
    <a href="{% url 'clinical_portal:treatment_plans' %}" class="btn-filter btn-clear"><i class="fas fa-times"></i> Clear</a>
</form>

<!-- Plans -->
{% if plans %}
<div class="plans-list">
    {% for plan in plans %}
    <div class="plan-card">
        <div class="plan-icon"><i class="fas fa-clipboard-list"></i></div>
        <div class="plan-body">
            <div class="plan-title">{{ plan.title }}</div>
            <div class="plan-patient">
                <i class="fas fa-user" style="font-size:.65rem;"></i>
                {{ plan.patient.get_full_name|default:plan.patient.username }}
            </div>
            {% if plan.diagnosis %}
            <div class="plan-diagnosis">{{ plan.diagnosis }}</div>
            {% endif %}
            <div class="plan-meta">
                <span class="plan-meta-item"><i class="fas fa-calendar"></i> {{ plan.start_date }}</span>
                {% if plan.end_date %}<span class="plan-meta-item"><i class="fas fa-calendar-check"></i> Ends {{ plan.end_date }}</span>{% endif %}
                {% if plan.next_review_date %}<span class="plan-meta-item"><i class="fas fa-clock"></i> Review {{ plan.next_review_date }}</span>{% endif %}
            </div>
        </div>
        <div style="display: flex; flex-direction: column; align-items: flex-end; gap: .5rem; flex-shrink: 0;">
            <span class="status-badge status-{{ plan.status }}">{{ plan.get_status_display }}</span>
            <a href="{% url 'clinical_portal:treatment_plan_detail' plan.pk %}" class="view-link">View →</a>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="empty-state">
    <i class="fas fa-clipboard" style="font-size: 2.5rem; color: var(--neutral-300); display: block; margin-bottom: 1rem;"></i>
    <p>No treatment plans found.</p>
</div>
{% endif %}
<!-- Add Treatment Plan Modal -->
<div class="modal-overlay" id="planModal">
    <div class="modal-box">
        <div class="modal-header">
            <h2><i class="fas fa-clipboard-list" style="color:var(--healthcare-primary);margin-right:.5rem;"></i>Create Treatment Plan</h2>
            <button class="modal-close" id="closePlanModal">&times;</button>
        </div>
        <form method="post" action="{% url 'clinical_portal:treatment_plans' %}">
            {% csrf_token %}
            <div class="form-grid">
                <div class="form-group full">
                    <label class="form-label">Patient <span>*</span></label>
                    <select name="patient" class="form-control" required>
                        <option value="">— Select patient —</option>
                        {% for p in patients %}
                        <option value="{{ p.id }}">{{ p.get_full_name|default:p.username }} ({{ p.email }})</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group full">
                    <label class="form-label">Plan Title <span>*</span></label>
                    <input type="text" name="title" class="form-control" placeholder="e.g. Hypertension Management Plan" required>
                </div>

                <div class="form-group full">
                    <label class="form-label">Diagnosis <span>*</span></label>
                    <input type="text" name="diagnosis" class="form-control" placeholder="Primary diagnosis being treated" required>
                </div>

                <div class="form-group full">
                    <label class="form-label">Description <span>*</span></label>
                    <textarea name="description" class="form-control" rows="3" placeholder="Overview of the treatment plan" required></textarea>
                </div>

                <div class="form-group full">
                    <label class="form-label">Medications</label>
                    <textarea name="medications" class="form-control" rows="2" placeholder="Prescribed medications with dosage"></textarea>
                </div>

                <div class="form-group full">
                    <label class="form-label">Procedures / Interventions</label>
                    <textarea name="procedures" class="form-control" rows="2" placeholder="Scheduled medical procedures"></textarea>
                </div>

                <div class="form-group full">
                    <label class="form-label">Lifestyle Recommendations</label>
                    <textarea name="lifestyle_recommendations" class="form-control" rows="2" placeholder="Diet, exercise, etc."></textarea>
                </div>

                <div class="form-group full">
                    <label class="form-label">Follow-up Instructions</label>
                    <textarea name="follow_up_instructions" class="form-control" rows="2" placeholder="Information for next visit"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select name="status" class="form-control">
                        {% for val, label in status_choices %}
                        <option value="{{ val }}" {% if val == 'active' %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Start Date</label>
                    <input type="date" name="start_date" class="form-control">
                </div>

                <div class="form-group">
                    <label class="form-label">Expected End Date</label>
                    <input type="date" name="end_date" class="form-control">
                </div>

                <div class="form-group">
                    <label class="form-label">Next Review Date</label>
                    <input type="date" name="next_review_date" class="form-control">
                </div>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn-cancel" id="cancelPlanModal">Cancel</button>
                <button type="submit" class="btn-submit"><i class="fas fa-save"></i> Save Plan</button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('planModal');
    const openBtn = document.getElementById('openPlanModalBtn');
    const closeBtn = document.getElementById('closePlanModal');
    const cancelBtn = document.getElementById('cancelPlanModal');

    function openModal() { modal.classList.add('open'); document.body.style.overflow = 'hidden'; }
    function closeModal() { modal.classList.remove('open'); document.body.style.overflow = ''; }

    if (openBtn) openBtn.addEventListener('click', openModal);
    if (closeBtn) closeBtn.addEventListener('click', closeModal);
    if (cancelBtn) cancelBtn.addEventListener('click', closeModal);

    // Close on click outside
    window.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeModal();
        }
    });
});
</script>
{% endblock %}
